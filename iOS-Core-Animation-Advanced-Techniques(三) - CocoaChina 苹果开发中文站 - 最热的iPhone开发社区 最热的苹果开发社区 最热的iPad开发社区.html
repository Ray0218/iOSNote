<!DOCTYPE html>
<!-- saved from url=(0049)http://www.cocoachina.com/ios/20150105/10827.html -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta charset="UTF-8">
	
	<title>iOS-Core-Animation-Advanced-Techniques(三) -  CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区</title>
    <meta name="keywords" content="iOS核心动画,Core AnimationiPhone开发,iOS开发,iPad开发,Mac开发,苹果开发中文站,iPhone开发中文站,CocoaChina首页, Mac OS开发, Cocoa介绍,移动互联网,触控科技,Cocoa,Apple,developer,iOS,iPhone,iPad,iMac,iPod Touch,iPhone5,iPhone4S,iPad3,招聘,iPhone程序员,Objective-c,iPhone应用外包,ios6,ios面试,Cocos2d-x,cocos2d,iTunes,App Store,苹果开发">
	<meta name="description" content=" - CocoaChina 开发讨论区 最热的iOS开发论坛| 最热的Mac开发论坛 | 最热的iPhone开发论坛 | 最热的iPad开发论坛">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="baidu-tc-cerfication" content="3300a939a1098c27e94457b75a0bb8c1">		
	<link rel="stylesheet" href="http://cdn.cocimg.com/cms/templets/style/global.css?20151" media="all">	
	<link rel="stylesheet" href="http://cdn.cocimg.com/cms/templets/style/index.css?2015" media="all">	
	<link href="http://cdn.cocimg.com/cms/templets/style/module.css?2015" rel="stylesheet">
	<link href="http://cdn.cocimg.com/cms/templets/style/style.css?20151" rel="stylesheet">
	<script type="text/javascript" async="" src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/ga.js"></script><script type="text/javascript" async="" src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/ga.js"></script><script src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/hm.js"></script><script src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/jquery-1.7.2.min.js" type="text/javascript"></script>
	<script type="text/javascript" src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/abase.js"></script><script type="text/javascript" charset="gbk" src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/prebat.php"></script>
	
	<script>
		var _hmt = _hmt || [];
		(function() {
		  var hm = document.createElement("script");
		  hm.src = "//hm.baidu.com/hm.js?88399e4c4cf744609c4fc8c3a8935691";
		  var s = document.getElementsByTagName("script")[0]; 
		  s.parentNode.insertBefore(hm, s);
		})();
	</script>	
<script src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/share.js"></script><link rel="stylesheet" href="http://bdimg.share.baidu.com/static/api/css/share_style1_32.css"></head>
<body>
<!--top-->
<div class="top">
	<div id="topshow" class="t-wrap"><ul class="t-shortc"><li><a title="" target="_blank" href="http://open.cocoachina.com/">Cocos开发者平台</a></li><li><a title="" target="_blank" href="http://cn.cocos2d-x.org/">Cocos引擎中文官网</a></li><li><a title="" target="_blank" href="http://h5.cocoachina.com/">H5轻游戏平台</a></li></ul><div class="t-login"><a href="http://www.cocoachina.com/bbs/login.php" title="">登录</a><a class="reg" href="http://www.cocoachina.com/bbs/register.php" title="">注册</a></div></div>
</div>	
<!--./top-->
<div class="header">
	<div class="h-wrap">
    	<div class="h-logo">
        	<a href="http://www.cocoachina.com/" title="" style="margin: 0 37px 0 10px;float:left;"><img src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/logo.png" height="53"></a>
            <div class="search">
            	<form action="http://www.cocoachina.com/cms/plus/search.php" id="searchform" name="formsearch" method="post" target="_blank">
					<input type="hidden" name="kwtype" value="0">
					<input type="hidden" name="searchtype" value="titlekeyword">				
					<input name="keyword" value="" type="text" id="search_keyword" placeholder="站内搜索">
                    <input type="button" class="ser-btn" value="" onclick="search_check()">
				</form>
                <div class="h-tags clearfix">
                	<a href="http://www.cocoachina.com/cms/plus/search.php?kwtype=0&keyword=iOS+8&searchtype=titlekeyword" title="" target="_blank">iOS 8</a>
                    <a href="http://www.cocoachina.com/cms/plus/search.php?kwtype=0&keyword=Swift&searchtype=titlekeyword" title="" target="_blank">Swift</a>
                    <a href="http://www.cocoachina.com/cms/plus/search.php?kwtype=0&keyword=App%20Store&searchtype=titlekeyword" title="" target="_blank">App Store</a>
                    <a href="http://www.cocoachina.com/cms/plus/search.php?kwtype=0&keyword=Apple%20Watch&searchtype=titlekeyword" title="" target="_blank">Apple Watch</a>
                    <a href="http://www.cocoachina.com/cms/plus/search.php?kwtype=0&keyword=Metal&searchtype=titlekeyword" title="" target="_blank">Metal</a>
                    <a href="http://www.cocoachina.com/cms/plus/search.php?kwtype=0&keyword=Cocos%E5%BC%95%E6%93%8E&searchtype=titlekeyword" title="" target="_blank">Cocos引擎</a>
                    <a href="http://www.cocoachina.com/cms/plus/search.php?kwtype=0&keyword=%E6%89%8B%E6%B8%B8&searchtype=titlekeyword" title="" target="_blank">手游</a>
                </div>
            </div>
            <div class="cc-ad1">
				<script>CNZZ_SLOT_RENDER('323844');</script><script type="text/javascript" charset="gbk" src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/appgcm.php"></script>
            </div>
        </div>
        
        <div class="h-nav">        	          	
            <ul class="h-navl">
               	<li class="navl-1"><a id="ios" href="http://www.cocoachina.com/ios/" title="ios" class="light">iOS开发</a></li>
                <li class="navl-2"><a id="app_store" href="http://www.cocoachina.com/appstore/" title="appstore">App Store研究</a></li>
                <li class="navl-3"><a id="mac" href="http://www.cocoachina.com/mac/" title="mac">Mac开发</a></li>
                <li class="navl-4"><a id="design" href="http://www.cocoachina.com/design/" title="design">产品设计</a></li>
                <li class="navl-5"><a id="cocos" href="http://www.cocoachina.com/cocos/" title="cocos">Cocos引擎</a></li>
                <li class="navl-6"><a id="webapp" href="http://www.cocoachina.com/webapp/" title="webapp">WebApp</a></li>
                <li class="navl-1"><a id="swift" href="http://www.cocoachina.com/swift/" title="swift">Swift</a></li>
                <li class="navl-2"><a id="game" href="http://www.cocoachina.com/game/" title="game">游戏开发</a></li>
                <li class="navl-3"><a id="apple" href="http://www.cocoachina.com/apple/" title="apple">苹果相关</a></li>
                <li class="navl-4"><a id="market" href="http://www.cocoachina.com/market/" title="market">营销推广</a></li>
                <li class="navl-5"><a id="industry" href="http://www.cocoachina.com/industry/" title="industry">业界动态</a></li>
                <li class="navl-6"><a id="programmer" href="http://www.cocoachina.com/programmer/" title="programmer">程序人生</a></li>
            </ul> 
            <ul class="h-navr">
               	<li><a target="_blank" href="http://www.cocoachina.com/bbs/" title="bbs">论坛</a></li>
                <li><a target="_blank" href="http://code.cocoachina.com/" title="code">代码</a></li>
                <li><a target="_blank" href="http://www.cocoachina.com/special/index.html" title="special">专题</a></li>
                <li><a target="_blank" href="http://www.cocoachina.com/events/" title="events">活动</a></li>
                <li class="navr-last"><a target="_blank" href="http://job.cocoachina.com/" title="job">招聘</a></li>
            </ul>          
        </div>
    </div>
</div>


<script language="javascript">
    function IsPC() { 
		var userAgentInfo = navigator.userAgent; 
		var Agents = new Array("Android", "iPhone", "SymbianOS", "Windows Phone", "iPod"); 
		var flag = true; 
		for (var v = 0; v < Agents.length; v++) { 
		if (userAgentInfo.indexOf(Agents[v]) > 0) { flag = false; break; } 
		} 
		return flag; 
	}
    if (!IsPC()){
           window.location.href = "http://www.cocoachina.com/cms/wap.php?action=article&id=10827"; 
    }
	
</script>
<!--middle-->
<div class="middle clearfix">
	<div class="m-wrap">
		<!--left-->
		<div class="detail-left float-l">
			<p class="crumbs"><a href="http://www.cocoachina.com/" title="首页">首页</a> &gt;<a href="http://www.cocoachina.com/ios" title="iOS开发"><span id="type_name">iOS开发</span></a></p>  	       
			<div class="detail-main">
			<h2>iOS-Core-Animation-Advanced-Techniques(三)</h2>
			<div class="p-ico clearfix">
				<div>
					<span class="ml0">2015-01-05 17:28</span>
					<span>编辑：
					<a href="http://www.cocoachina.com/bbs/u.php?action=feed&uid=340873" id="field_author" target="_blank">suiling</a></span>
					<span>分类：<a href="http://www.cocoachina.com/ios/" target="_blank">iOS开发</a></span>
					<span id="source">来源：<a href="https://github.com/AttackOnDobby" target="_blank">FeiXu（github主页）</a></span>

					<div class="float-r">
						<span><i></i> <script src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/count.php"></script>0</span>
						<span><i class="view"></i><script src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/count(1).php" language="javascript"></script>1592</span>
				</div>
				</div>
			</div>
			<div class="p-ico clearfix">
				<p class="related float-l"><a href="http://www.cocoachina.com/cms/tags.php?/Core+animation/" target="_blank">Core animation</a><a href="http://www.cocoachina.com/cms/tags.php?/iOS%E6%A0%B8%E5%BF%83%E5%8A%A8%E7%94%BB/" target="_blank">iOS核心动画</a></p>
				<input type="hidden" id="article_id" value="10827">
			</div>
			<div class="adsbox clearfix">
				<div class="float-l">
					<div class="float-l"><b>招聘信息：</b></div>
					<ul class="float-l" id="invitelist" style="margin-top: 0px;"><li><a href="http://www.cocoachina.com/bbs/read.php?tid=286630" target="_blank">寻 iOS产品数据库查询app开发供应商，江浙沪京。</a></li><li><a href="http://www.cocoachina.com/bbs/read.php?tid=286568" target="_blank">急招ios开发工程师</a></li></ul>
				</div>
				<div class="float-r">
					<a href="javascript:void(0)" class="prev"></a>
					<a href="javascript:void(0)" class="next"></a>
				</div>
			</div>
			<div id="detailbody" class="field_body">
				<p style="text-align: center;"><strong><span style="font-size: 14px; line-height: 25.200000762939453px; color: rgb(0, 176, 80);">专用图层</span></strong></p><p><span style="color: rgb(149, 55, 52);">复杂的组织都是专门化的--<span style="line-height: 1.8;">Catharine R. Stimpson</span></span></p><p>到目前为止，我们已经探讨过CALayer类了，同时我们也了解到了一些非常有用的绘图和动画功能。但是Core Animation图层不仅仅能作用于图片和颜色而已。本章就会学习其他的一些图层类，进一步扩展使用Core Animation绘图的能力。</p><p><strong>CAShapeLayer</strong></p><p>在第四章『视觉效果』我们学习到了不使用图片的情况下用CGPath去构造任意形状的阴影。如果我们能用同样的方式创建相同形状的图层就好了。</p><p>CAShapeLayer是一个通过矢量图形而不是bitmap来绘制的图层子类。你指定诸如颜色和线宽等属性，用CGPath来定义想要绘制的图形，最后CAShapeLayer就自动渲染出来了。当然，你也可以用Core Graphics直接向原始的CALyer的内容中绘制一个路径，相比直下，使用CAShapeLayer有以下一些优点：</p><ul class=" list-paddingleft-2" style="list-style-type: disc;"><li><p>渲染快速。CAShapeLayer使用了硬件加速，绘制同一图形会比用Core Graphics快很多。</p></li><li><p>高效使用内存。一个CAShapeLayer不需要像普通CALayer一样创建一个寄宿图形，所以无论有多大，都不会占用太多的内存。</p></li><li><p>不会被图层边界剪裁掉。一个CAShapeLayer可以在边界之外绘制。你的图层路径不会像在使用Core Graphics的普通CALayer一样被剪裁掉（如我们在第二章所见）。</p></li><li><p>不会出现像素化。当你给CAShapeLayer做3D变换时，它不像一个有寄宿图的普通图层一样变得像素化。</p></li></ul><p><span style="color: rgb(149, 55, 52);">创建一个CGPath</span></p><p>CAShapeLayer可以用来绘制所有能够通过CGPath来表示的形状。这个形状不一定要闭合，图层路径也不一定要不可破，事实上你可以在一个图层上绘制好几个不同的形状。你可以控制一些属性比如lineWith（线宽，用点表示单位），lineCap（线条结尾的样子），和lineJoin（线条之间的结合点的样子）；但是在图层层面你只有一次机会设置这些属性。如果你想用不同颜色或风格来绘制多个形状，就不得不为每个形状准备一个图层了。</p><p>清单6.1 的代码用一个CAShapeLayer渲染一个简单的火柴人。CAShapeLayer属性是CGPathRef类型，但是我们用UIBezierPath帮助类创建了图层路径，这样我们就不用考虑人工释放CGPath了。图6.1是代码运行的结果。虽然还不是很完美，但是总算知道了大意对吧！</p><p>清单6.1 用CAShapeLayer绘制一个火柴人</p><div><div id="highlighter_262559" class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js preprocessor">#import&nbsp;"DrawingView.h"</code></div><div class="line number2 index1 alt1"><code class="js preprocessor">#import&nbsp;@interface&nbsp;ViewController&nbsp;()</code></div><div class="line number3 index2 alt2"><code class="js plain">@property&nbsp;(nonatomic,&nbsp;weak)&nbsp;IBOutlet&nbsp;UIView&nbsp;*containerView;</code></div><div class="line number4 index3 alt1"><code class="js plain">@end</code></div><div class="line number5 index4 alt2"><code class="js plain">@implementation&nbsp;ViewController</code></div><div class="line number6 index5 alt1"><code class="js plain">-&nbsp;(void)viewDidLoad</code></div><div class="line number7 index6 alt2"><code class="js plain">{</code></div><div class="line number8 index7 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">[</code><code class="js keyword">super</code>&nbsp;<code class="js plain">viewDidLoad];</code></div><div class="line number9 index8 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//create&nbsp;path</code></div><div class="line number10 index9 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">UIBezierPath&nbsp;*path&nbsp;=&nbsp;[[UIBezierPath&nbsp;alloc]&nbsp;init];</code></div><div class="line number11 index10 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">[path&nbsp;moveToPoint:CGPointMake(175,&nbsp;100)];</code></div><div class="line number12 index11 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">?</code></div><div class="line number13 index12 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">[path&nbsp;addArcWithCenter:CGPointMake(150,&nbsp;100)&nbsp;radius:25&nbsp;startAngle:0&nbsp;endAngle:2*M_PI&nbsp;clockwise:YES];</code></div><div class="line number14 index13 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">[path&nbsp;moveToPoint:CGPointMake(150,&nbsp;125)];</code></div><div class="line number15 index14 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">[path&nbsp;addLineToPoint:CGPointMake(150,&nbsp;175)];</code></div><div class="line number16 index15 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">[path&nbsp;addLineToPoint:CGPointMake(125,&nbsp;225)];</code></div><div class="line number17 index16 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">[path&nbsp;moveToPoint:CGPointMake(150,&nbsp;175)];</code></div><div class="line number18 index17 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">[path&nbsp;addLineToPoint:CGPointMake(175,&nbsp;225)];</code></div><div class="line number19 index18 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">[path&nbsp;moveToPoint:CGPointMake(100,&nbsp;150)];</code></div><div class="line number20 index19 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">[path&nbsp;addLineToPoint:CGPointMake(200,&nbsp;150)];</code></div><div class="line number21 index20 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//create&nbsp;shape&nbsp;layer</code></div><div class="line number22 index21 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">CAShapeLayer&nbsp;*shapeLayer&nbsp;=&nbsp;[CAShapeLayer&nbsp;layer];</code></div><div class="line number23 index22 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">shapeLayer.strokeColor&nbsp;=&nbsp;[UIColor&nbsp;redColor].CGColor;</code></div><div class="line number24 index23 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">shapeLayer.fillColor&nbsp;=&nbsp;[UIColor&nbsp;clearColor].CGColor;</code></div><div class="line number25 index24 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">shapeLayer.lineWidth&nbsp;=&nbsp;5;</code></div><div class="line number26 index25 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">shapeLayer.lineJoin&nbsp;=&nbsp;kCALineJoinRound;</code></div><div class="line number27 index26 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">shapeLayer.lineCap&nbsp;=&nbsp;kCALineCapRound;</code></div><div class="line number28 index27 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">shapeLayer.path&nbsp;=&nbsp;path.CGPath;</code></div><div class="line number29 index28 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//add&nbsp;it&nbsp;to&nbsp;our&nbsp;view</code></div><div class="line number30 index29 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">[self.containerView.layer&nbsp;addSublayer:shapeLayer];</code></div><div class="line number31 index30 alt2"><code class="js plain">}</code></div><div class="line number32 index31 alt1"><code class="js plain">@end</code></div></div></td></tr></tbody></table></div></div><p style="text-align:center"><img src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/1420356465350418.png" title="1420356465350418.png" alt="6.1.png" style="width: 479px; height: 248px;"></p><p>图6.1 用CAShapeLayer绘制一个简单的火柴人</p><p><span style="color: rgb(149, 55, 52);">圆角</span></p><p>第二章里面提到了CAShapeLayer为创建圆角视图提供了一个方法，就是CALayer的cornerRadius属性（译者注：其实是在第四章提到的）。虽然使用CAShapeLayer类需要更多的工作，但是它有一个优势就是可以单独指定每个角。</p><p>我们创建圆角举行其实就是人工绘制单独的直线和弧度，但是事实上UIBezierPath有自动绘制圆角矩形的构造方法，下面这段代码绘制了一个有三个圆角一个直角的矩形：</p><div><div id="highlighter_733550" class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js comments">//define&nbsp;path&nbsp;parameters</code></div><div class="line number2 index1 alt1"><code class="js plain">CGRect&nbsp;rect&nbsp;=&nbsp;CGRectMake(50,&nbsp;50,&nbsp;100,&nbsp;100);</code></div><div class="line number3 index2 alt2"><code class="js plain">CGSize&nbsp;radii&nbsp;=&nbsp;CGSizeMake(20,&nbsp;20);</code></div><div class="line number4 index3 alt1"><code class="js plain">UIRectCorner&nbsp;corners&nbsp;=&nbsp;UIRectCornerTopRight&nbsp;|&nbsp;UIRectCornerBottomRight&nbsp;|&nbsp;UIRectCornerBottomLeft;</code></div><div class="line number5 index4 alt2"><code class="js comments">//create&nbsp;path</code></div><div class="line number6 index5 alt1"><code class="js plain">UIBezierPath&nbsp;*path&nbsp;=&nbsp;[UIBezierPath&nbsp;bezierPathWithRoundedRect:rect&nbsp;byRoundingCorners:corners&nbsp;cornerRadii:radii];</code></div></div></td></tr></tbody></table></div></div><p>我们可以通过这个图层路径绘制一个既有直角又有圆角的视图。如果我们想依照此图形来剪裁视图内容，我们可以把CAShapeLayer作为视图的宿主图层，而不是添加一个子视图（图层蒙板的详细解释见第四章『视觉效果』）。</p><p><strong>CATextLayer</strong></p><p>用户界面是无法从一个单独的图片里面构建的。一个设计良好的图标能够很好地表现一个按钮或控件的意图，不过你迟早都要需要一个不错的老式风格的文本标签。</p><p>如果你想在一个图层里面显示文字，完全可以借助图层代理直接将字符串使用Core Graphics写入图层的内容（这就是UILabel的精髓）。如果越过寄宿于图层的视图，直接在图层上操作，那其实相当繁琐。你要为每一个显示文字的图层创建一个能像图层代理一样工作的类，还要逻辑上判断哪个图层需要显示哪个字符串，更别提还要记录不同的字体，颜色等一系列乱七八糟的东西。</p><p>万幸的是这些都是不必要的，Core Animation提供了一个CALayer的子类CATextLayer，它以图层的形式包含了UILabel几乎所有的绘制特性，并且额外提供了一些新的特性。</p><p>同样，CATextLayer也要比UILabel渲染得快得多。很少有人知道在iOS 6及之前的版本，UILabel其实是通过WebKit来实现绘制的，这样就造成了当有很多文字的时候就会有极大的性能压力。而CATextLayer使用了Core text，并且渲染得非常快。</p><p>让我们来尝试用CATextLayer来显示一些文字。清单6.2的代码实现了这一功能，结果如图6.2所示。</p><p>清单6.2 用CATextLayer来实现一个UILabel</p><div><div id="highlighter_972267" class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js plain">@interface&nbsp;ViewController&nbsp;()</code></div><div class="line number2 index1 alt1"><code class="js plain">@property&nbsp;(nonatomic,&nbsp;weak)&nbsp;IBOutlet&nbsp;UIView&nbsp;*labelView;</code></div><div class="line number3 index2 alt2"><code class="js plain">@end</code></div><div class="line number4 index3 alt1"><code class="js plain">@implementation&nbsp;ViewController</code></div><div class="line number5 index4 alt2"><code class="js plain">-&nbsp;(void)viewDidLoad</code></div><div class="line number6 index5 alt1"><code class="js plain">{</code></div><div class="line number7 index6 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">[</code><code class="js keyword">super</code>&nbsp;<code class="js plain">viewDidLoad];</code></div><div class="line number8 index7 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//create&nbsp;a&nbsp;text&nbsp;layer</code></div><div class="line number9 index8 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">CATextLayer&nbsp;*textLayer&nbsp;=&nbsp;[CATextLayer&nbsp;layer];</code></div><div class="line number10 index9 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">textLayer.frame&nbsp;=&nbsp;self.labelView.bounds;</code></div><div class="line number11 index10 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">[self.labelView.layer&nbsp;addSublayer:textLayer];</code></div><div class="line number12 index11 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//set&nbsp;text&nbsp;attributes</code></div><div class="line number13 index12 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">textLayer.foregroundColor&nbsp;=&nbsp;[UIColor&nbsp;blackColor].CGColor;</code></div><div class="line number14 index13 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">textLayer.alignmentMode&nbsp;=&nbsp;kCAAlignmentJustified;</code></div><div class="line number15 index14 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">textLayer.wrapped&nbsp;=&nbsp;YES;</code></div><div class="line number16 index15 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//choose&nbsp;a&nbsp;font</code></div><div class="line number17 index16 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">UIFont&nbsp;*font&nbsp;=&nbsp;[UIFont&nbsp;systemFontOfSize:15];</code></div><div class="line number18 index17 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//set&nbsp;layer&nbsp;font</code></div><div class="line number19 index18 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">CFStringRef&nbsp;fontName&nbsp;=&nbsp;(__bridge&nbsp;CFStringRef)font.fontName;</code></div><div class="line number20 index19 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">CGFontRef&nbsp;fontRef&nbsp;=&nbsp;CGFontCreateWithFontName(fontName);</code></div><div class="line number21 index20 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">textLayer.font&nbsp;=&nbsp;fontRef;</code></div><div class="line number22 index21 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">textLayer.fontSize&nbsp;=&nbsp;font.pointSize;</code></div><div class="line number23 index22 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">CGFontRelease(fontRef);</code></div><div class="line number24 index23 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//choose&nbsp;some&nbsp;text</code></div><div class="line number25 index24 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">NSString&nbsp;*text&nbsp;=&nbsp;@</code><code class="js string">"Lorem&nbsp;ipsum&nbsp;dolor&nbsp;sit&nbsp;amet,&nbsp;consectetur&nbsp;adipiscing&nbsp;\&nbsp;elit.&nbsp;Quisque&nbsp;massa&nbsp;arcu,&nbsp;eleifend&nbsp;vel&nbsp;varius&nbsp;in,&nbsp;facilisis&nbsp;pulvinar&nbsp;\&nbsp;leo.&nbsp;Nunc&nbsp;quis&nbsp;nunc&nbsp;at&nbsp;mauris&nbsp;pharetra&nbsp;condimentum&nbsp;ut&nbsp;ac&nbsp;neque.&nbsp;Nunc&nbsp;elementum,&nbsp;libero&nbsp;ut&nbsp;porttitor&nbsp;dictum,&nbsp;diam&nbsp;odio&nbsp;congue&nbsp;lacus,&nbsp;vel&nbsp;\&nbsp;fringilla&nbsp;sapien&nbsp;diam&nbsp;at&nbsp;purus.&nbsp;Etiam&nbsp;suscipit&nbsp;pretium&nbsp;nunc&nbsp;sit&nbsp;amet&nbsp;\&nbsp;lobortis"</code><code class="js plain">;</code></div><div class="line number26 index25 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//set&nbsp;layer&nbsp;text</code></div><div class="line number27 index26 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">textLayer.string&nbsp;=&nbsp;text;</code></div><div class="line number28 index27 alt1"><code class="js plain">}</code></div><div class="line number29 index28 alt2"><code class="js plain">@end</code></div></div></td></tr></tbody></table></div></div><p>*********************<br><span style="line-height: 1.8;">图6.2 用CATextLayer来显示一个纯文本标签</span></p><p>如果你自习看这个文本，你会发现一个奇怪的地方：这些文本有一些像素化了。这是因为并没有以Retina的方式渲染，第二章提到了这个contentScale属性，用来决定图层内容应该以怎样的分辨率来渲染。contentsScale并不关心屏幕的拉伸因素而总是默认为1.0。如果我们想以Retina的质量来显示文字，我们就得手动地设置CATextLayer的contentsScale属性，如下：</p><div><div id="highlighter_302762" class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js plain">textLayer.contentsScale&nbsp;=&nbsp;[UIScreen&nbsp;mainScreen].scale;</code></div></div></td></tr></tbody></table></div></div><p>这样就解决了这个问题（如图6.3）</p><p style="text-align:center"><img src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/1420356625148947.png" title="1420356625148947.png" alt="6.3.png" style="width: 481px; height: 253px;"></p><p>图6.3 设置contentsScale来匹配屏幕</p><p>CATextLayer的font属性不是一个UIFont类型，而是一个CFTypeRef类型。这样可以根据你的具体需要来决定字体属性应该是用CGFontRef类型还是CTFontRef类型（Core Text字体）。同时字体大小也是用fontSize属性单独设置的，因为CTFontRef和CGFontRef并不像UIFont一样包含点大小。这个例子会告诉你如何将UIFont转换成CGFontRef。</p><p>另外，CATextLayer的string属性并不是你想象的NSString类型，而是id类型。这样你既可以用NSString也可以用NSAttributedString来指定文本了（注意，NSAttributedString并不是NSString的子类）。属性化字符串是iOS用来渲染字体风格的机制，它以特定的方式来决定指定范围内的字符串的原始信息，比如字体，颜色，字重，斜体等。</p><p><span style="color: rgb(149, 55, 52);">富文本</span></p><p>iOS 6中，Apple给UILabel和其他UIKit文本视图添加了直接的属性化字符串的支持，应该说这是一个很方便的特性。不过事实上从iOS3.2开始CATextLayer就已经支持属性化字符串了。这样的话，如果你想要支持更低版本的iOS系统，CATextLayer无疑是你向界面中增加富文本的好办法，而且也不用去跟复杂的Core Text打交道，也省了用UIWebView的麻烦。</p><p>让我们编辑一下示例使用到NSAttributedString（见清单6.3）.iOS 6及以上我们可以用新的NSTextAttributeName实例来设置我们的字符串属性，但是练习的目的是为了演示在iOS 5及以下，所以我们用了Core Text，也就是说你需要把Core Text framework添加到你的项目中。否则，编译器是无法识别属性常量的。</p><p>图6.4是代码运行结果（注意那个红色的下划线文本）</p><p>清单6.3 用NSAttributedString实现一个富文本标签。</p><div><div id="highlighter_415160" class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div><div class="line number37 index36 alt2">37</div><div class="line number38 index37 alt1">38</div><div class="line number39 index38 alt2">39</div><div class="line number40 index39 alt1">40</div><div class="line number41 index40 alt2">41</div><div class="line number42 index41 alt1">42</div><div class="line number43 index42 alt2">43</div><div class="line number44 index43 alt1">44</div><div class="line number45 index44 alt2">45</div><div class="line number46 index45 alt1">46</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js preprocessor">#import&nbsp;"DrawingView.h"</code></div><div class="line number2 index1 alt1"><code class="js preprocessor">#import&nbsp;#import&nbsp;@interface&nbsp;ViewController&nbsp;()</code></div><div class="line number3 index2 alt2"><code class="js plain">@property&nbsp;(nonatomic,&nbsp;weak)&nbsp;IBOutlet&nbsp;UIView&nbsp;*labelView;</code></div><div class="line number4 index3 alt1"><code class="js plain">@end</code></div><div class="line number5 index4 alt2"><code class="js plain">@implementation&nbsp;ViewController</code></div><div class="line number6 index5 alt1"><code class="js plain">-&nbsp;(void)viewDidLoad</code></div><div class="line number7 index6 alt2"><code class="js plain">{</code></div><div class="line number8 index7 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">[</code><code class="js keyword">super</code>&nbsp;<code class="js plain">viewDidLoad];</code></div><div class="line number9 index8 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//create&nbsp;a&nbsp;text&nbsp;layer</code></div><div class="line number10 index9 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">CATextLayer&nbsp;*textLayer&nbsp;=&nbsp;[CATextLayer&nbsp;layer];</code></div><div class="line number11 index10 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">textLayer.frame&nbsp;=&nbsp;self.labelView.bounds;</code></div><div class="line number12 index11 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">textLayer.contentsScale&nbsp;=&nbsp;[UIScreen&nbsp;mainScreen].scale;</code></div><div class="line number13 index12 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">[self.labelView.layer&nbsp;addSublayer:textLayer];</code></div><div class="line number14 index13 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//set&nbsp;text&nbsp;attributes</code></div><div class="line number15 index14 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">textLayer.alignmentMode&nbsp;=&nbsp;kCAAlignmentJustified;</code></div><div class="line number16 index15 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">textLayer.wrapped&nbsp;=&nbsp;YES;</code></div><div class="line number17 index16 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//choose&nbsp;a&nbsp;font</code></div><div class="line number18 index17 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">UIFont&nbsp;*font&nbsp;=&nbsp;[UIFont&nbsp;systemFontOfSize:15];</code></div><div class="line number19 index18 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//choose&nbsp;some&nbsp;text</code></div><div class="line number20 index19 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">NSString&nbsp;*text&nbsp;=&nbsp;@</code><code class="js string">"Lorem&nbsp;ipsum&nbsp;dolor&nbsp;sit&nbsp;amet,&nbsp;consectetur&nbsp;adipiscing&nbsp;\&nbsp;elit.&nbsp;Quisque&nbsp;massa&nbsp;arcu,&nbsp;eleifend&nbsp;vel&nbsp;varius&nbsp;in,&nbsp;facilisis&nbsp;pulvinar&nbsp;\&nbsp;leo.&nbsp;Nunc&nbsp;quis&nbsp;nunc&nbsp;at&nbsp;mauris&nbsp;pharetra&nbsp;condimentum&nbsp;ut&nbsp;ac&nbsp;neque.&nbsp;Nunc&nbsp;\&nbsp;elementum,&nbsp;libero&nbsp;ut&nbsp;porttitor&nbsp;dictum,&nbsp;diam&nbsp;odio&nbsp;congue&nbsp;lacus,&nbsp;vel&nbsp;\&nbsp;fringilla&nbsp;sapien&nbsp;diam&nbsp;at&nbsp;purus.&nbsp;Etiam&nbsp;suscipit&nbsp;pretium&nbsp;nunc&nbsp;sit&nbsp;amet&nbsp;\&nbsp;lobortis"</code><code class="js plain">;</code></div><div class="line number21 index20 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">?</code></div><div class="line number22 index21 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//create&nbsp;attributed&nbsp;string</code></div><div class="line number23 index22 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">NSMutableAttributedString&nbsp;*string&nbsp;=&nbsp;nil;</code></div><div class="line number24 index23 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">string&nbsp;=&nbsp;[[NSMutableAttributedString&nbsp;alloc]&nbsp;initWithString:text];</code></div><div class="line number25 index24 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//convert&nbsp;UIFont&nbsp;to&nbsp;a&nbsp;CTFont</code></div><div class="line number26 index25 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">CFStringRef&nbsp;fontName&nbsp;=&nbsp;(__bridge&nbsp;CFStringRef)font.fontName;</code></div><div class="line number27 index26 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">CGFloat&nbsp;fontSize&nbsp;=&nbsp;font.pointSize;</code></div><div class="line number28 index27 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">CTFontRef&nbsp;fontRef&nbsp;=&nbsp;CTFontCreateWithName(fontName,&nbsp;fontSize,&nbsp;NULL);</code></div><div class="line number29 index28 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//set&nbsp;text&nbsp;attributes</code></div><div class="line number30 index29 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">NSDictionary&nbsp;*attribs&nbsp;=&nbsp;@{</code></div><div class="line number31 index30 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">(__bridge&nbsp;id)kCTForegroundColorAttributeName:(__bridge&nbsp;id)[UIColor&nbsp;blackColor].CGColor,</code></div><div class="line number32 index31 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">(__bridge&nbsp;id)kCTFontAttributeName:&nbsp;(__bridge&nbsp;id)fontRef</code></div><div class="line number33 index32 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">};</code></div><div class="line number34 index33 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">[string&nbsp;setAttributes:attribs&nbsp;range:NSMakeRange(0,&nbsp;[text&nbsp;length])];</code></div><div class="line number35 index34 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">attribs&nbsp;=&nbsp;@{</code></div><div class="line number36 index35 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">(__bridge&nbsp;id)kCTForegroundColorAttributeName:&nbsp;(__bridge&nbsp;id)[UIColor&nbsp;redColor].CGColor,</code></div><div class="line number37 index36 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">(__bridge&nbsp;id)kCTUnderlineStyleAttributeName:&nbsp;@(kCTUnderlineStyleSingle),</code></div><div class="line number38 index37 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">(__bridge&nbsp;id)kCTFontAttributeName:&nbsp;(__bridge&nbsp;id)fontRef</code></div><div class="line number39 index38 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">};</code></div><div class="line number40 index39 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">[string&nbsp;setAttributes:attribs&nbsp;range:NSMakeRange(6,&nbsp;5)];</code></div><div class="line number41 index40 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//release&nbsp;the&nbsp;CTFont&nbsp;we&nbsp;created&nbsp;earlier</code></div><div class="line number42 index41 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">CFRelease(fontRef);</code></div><div class="line number43 index42 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//set&nbsp;layer&nbsp;text</code></div><div class="line number44 index43 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">textLayer.string&nbsp;=&nbsp;string;</code></div><div class="line number45 index44 alt2"><code class="js plain">}</code></div><div class="line number46 index45 alt1"><code class="js plain">@end</code></div></div></td></tr></tbody></table></div></div><p style="text-align:center"><img src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/1420356760722857.png" title="1420356760722857.png" alt="6.4.png" style="width: 479px; height: 240px;"></p><p>图6.4 用CATextLayer实现一个富文本标签。</p><p><span style="color: rgb(149, 55, 52);">行距和字距</span></p><p>有必要提一下的是，由于绘制的实现机制不同（Core Text和WebKit），用CATextLayer渲染和用UILabel渲染出的文本行距和字距也不是不尽相同的。</p><p>二者的差异程度（由使用的字体和字符决定）总的来说挺小，但是如果你想正确的显示普通便签和CATextLayer就一定要记住这一点。</p><p><span style="color: rgb(149, 55, 52);">UILabel的替代品</span></p><p>我们已经证实了CATextLayer比UILabel有着更好的性能表现，同时还有额外的布局选项并且在iOS 5上支持富文本。但是与一般的标签比较而言会更加繁琐一些。如果我们真的在需求一个UILabel的可用替代品，最好是能够在Interface Builder上创建我们的标签，而且尽可能地像一般的视图一样正常工作。</p><p>我们应该继承UILabel，然后添加一个子图层CATextLayer并重写显示文本的方法。但是仍然会有由UILabel的-drawRect:方法创建的空寄宿图。而且由于CALayer不支持自动缩放和自动布局，子视图并不是主动跟踪视图边界的大小，所以每次视图大小被更改，我们不得不手动更新子图层的边界。</p><p>我们真正想要的是一个用CATextLayer作为宿主图层的UILabel子类，这样就可以随着视图自动调整大小而且也没有冗余的寄宿图啦。</p><p>就像我们在第一章『图层树』讨论的一样，每一个UIView都是寄宿在一个CALayer的示例上。这个图层是由视图自动创建和管理的，那我们可以用别的图层类型替代它么？一旦被创建，我们就无法代替这个图层了。但是如果我们继承了UIView，那我们就可以重写+layerClass方法使得在创建的时候能返回一个不同的图层子类。UIView会在初始化的时候调用+layerClass方法，然后用它的返回类型来创建宿主图层。</p><p>清单6.4 演示了一个UILabel子类LayerLabel用CATextLayer绘制它的问题，而不是调用一般的UILabel使用的较慢的-drawRect：方法。LayerLabel示例既可以用代码实现，也可以在Interface Builder实现，只要把普通的标签拖入视图之中，然后设置它的类是LayerLabel就可以了。</p><p>清单6.4 使用CATextLayer的UILabel子类：LayerLabel</p><div><div id="highlighter_44975" class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div><div class="line number37 index36 alt2">37</div><div class="line number38 index37 alt1">38</div><div class="line number39 index38 alt2">39</div><div class="line number40 index39 alt1">40</div><div class="line number41 index40 alt2">41</div><div class="line number42 index41 alt1">42</div><div class="line number43 index42 alt2">43</div><div class="line number44 index43 alt1">44</div><div class="line number45 index44 alt2">45</div><div class="line number46 index45 alt1">46</div><div class="line number47 index46 alt2">47</div><div class="line number48 index47 alt1">48</div><div class="line number49 index48 alt2">49</div><div class="line number50 index49 alt1">50</div><div class="line number51 index50 alt2">51</div><div class="line number52 index51 alt1">52</div><div class="line number53 index52 alt2">53</div><div class="line number54 index53 alt1">54</div><div class="line number55 index54 alt2">55</div><div class="line number56 index55 alt1">56</div><div class="line number57 index56 alt2">57</div><div class="line number58 index57 alt1">58</div><div class="line number59 index58 alt2">59</div><div class="line number60 index59 alt1">60</div><div class="line number61 index60 alt2">61</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js preprocessor">#import&nbsp;"LayerLabel.h"</code></div><div class="line number2 index1 alt1"><code class="js preprocessor">#import&nbsp;@implementation&nbsp;LayerLabel</code></div><div class="line number3 index2 alt2"><code class="js plain">+&nbsp;(Class)layerClass</code></div><div class="line number4 index3 alt1"><code class="js plain">{</code></div><div class="line number5 index4 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//this&nbsp;makes&nbsp;our&nbsp;label&nbsp;create&nbsp;a&nbsp;CATextLayer&nbsp;//instead&nbsp;of&nbsp;a&nbsp;regular&nbsp;CALayer&nbsp;for&nbsp;its&nbsp;backing&nbsp;layer</code></div><div class="line number6 index5 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js keyword">return</code>&nbsp;<code class="js plain">[CATextLayer&nbsp;class];</code></div><div class="line number7 index6 alt2"><code class="js plain">}</code></div><div class="line number8 index7 alt1"><code class="js plain">-&nbsp;(CATextLayer&nbsp;*)textLayer</code></div><div class="line number9 index8 alt2"><code class="js plain">{</code></div><div class="line number10 index9 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js keyword">return</code>&nbsp;<code class="js plain">(CATextLayer&nbsp;*)self.layer;</code></div><div class="line number11 index10 alt2"><code class="js plain">}</code></div><div class="line number12 index11 alt1"><code class="js plain">-&nbsp;(void)setUp</code></div><div class="line number13 index12 alt2"><code class="js plain">{</code></div><div class="line number14 index13 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//set&nbsp;defaults&nbsp;from&nbsp;UILabel&nbsp;settings</code></div><div class="line number15 index14 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">self.text&nbsp;=&nbsp;self.text;</code></div><div class="line number16 index15 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">self.textColor&nbsp;=&nbsp;self.textColor;</code></div><div class="line number17 index16 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">self.font&nbsp;=&nbsp;self.font;</code></div><div class="line number18 index17 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//we&nbsp;should&nbsp;really&nbsp;derive&nbsp;these&nbsp;from&nbsp;the&nbsp;UILabel&nbsp;settings&nbsp;too</code></div><div class="line number19 index18 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//but&nbsp;that's&nbsp;complicated,&nbsp;so&nbsp;for&nbsp;now&nbsp;we'll&nbsp;just&nbsp;hard-code&nbsp;them</code></div><div class="line number20 index19 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">[self&nbsp;textLayer].alignmentMode&nbsp;=&nbsp;kCAAlignmentJustified;</code></div><div class="line number21 index20 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">?</code></div><div class="line number22 index21 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">[self&nbsp;textLayer].wrapped&nbsp;=&nbsp;YES;</code></div><div class="line number23 index22 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">[self.layer&nbsp;display];</code></div><div class="line number24 index23 alt1"><code class="js plain">}</code></div><div class="line number25 index24 alt2"><code class="js plain">-&nbsp;(id)initWithFrame:(CGRect)frame</code></div><div class="line number26 index25 alt1"><code class="js plain">{</code></div><div class="line number27 index26 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//called&nbsp;when&nbsp;creating&nbsp;label&nbsp;programmatically</code></div><div class="line number28 index27 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js keyword">if</code>&nbsp;<code class="js plain">(self&nbsp;=&nbsp;[</code><code class="js keyword">super</code>&nbsp;<code class="js plain">initWithFrame:frame])&nbsp;{</code></div><div class="line number29 index28 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">[self&nbsp;setUp];</code></div><div class="line number30 index29 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">}</code></div><div class="line number31 index30 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js keyword">return</code>&nbsp;<code class="js plain">self;</code></div><div class="line number32 index31 alt1"><code class="js plain">}</code></div><div class="line number33 index32 alt2"><code class="js plain">-&nbsp;(void)awakeFromNib</code></div><div class="line number34 index33 alt1"><code class="js plain">{</code></div><div class="line number35 index34 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//called&nbsp;when&nbsp;creating&nbsp;label&nbsp;using&nbsp;Interface&nbsp;Builder</code></div><div class="line number36 index35 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">[self&nbsp;setUp];</code></div><div class="line number37 index36 alt2"><code class="js plain">}</code></div><div class="line number38 index37 alt1"><code class="js plain">-&nbsp;(void)setText:(NSString&nbsp;*)text</code></div><div class="line number39 index38 alt2"><code class="js plain">{</code></div><div class="line number40 index39 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js keyword">super</code><code class="js plain">.text&nbsp;=&nbsp;text;</code></div><div class="line number41 index40 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//set&nbsp;layer&nbsp;text</code></div><div class="line number42 index41 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">[self&nbsp;textLayer].string&nbsp;=&nbsp;text;</code></div><div class="line number43 index42 alt2"><code class="js plain">}</code></div><div class="line number44 index43 alt1"><code class="js plain">-&nbsp;(void)setTextColor:(UIColor&nbsp;*)textColor</code></div><div class="line number45 index44 alt2"><code class="js plain">{</code></div><div class="line number46 index45 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js keyword">super</code><code class="js plain">.textColor&nbsp;=&nbsp;textColor;</code></div><div class="line number47 index46 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//set&nbsp;layer&nbsp;text&nbsp;color</code></div><div class="line number48 index47 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">[self&nbsp;textLayer].foregroundColor&nbsp;=&nbsp;textColor.CGColor;</code></div><div class="line number49 index48 alt2"><code class="js plain">}</code></div><div class="line number50 index49 alt1"><code class="js plain">-&nbsp;(void)setFont:(UIFont&nbsp;*)font</code></div><div class="line number51 index50 alt2"><code class="js plain">{</code></div><div class="line number52 index51 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js keyword">super</code><code class="js plain">.font&nbsp;=&nbsp;font;</code></div><div class="line number53 index52 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//set&nbsp;layer&nbsp;font</code></div><div class="line number54 index53 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">CFStringRef&nbsp;fontName&nbsp;=&nbsp;(__bridge&nbsp;CFStringRef)font.fontName;</code></div><div class="line number55 index54 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">CGFontRef&nbsp;fontRef&nbsp;=&nbsp;CGFontCreateWithFontName(fontName);</code></div><div class="line number56 index55 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">[self&nbsp;textLayer].font&nbsp;=&nbsp;fontRef;</code></div><div class="line number57 index56 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">[self&nbsp;textLayer].fontSize&nbsp;=&nbsp;font.pointSize;</code></div><div class="line number58 index57 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">?</code></div><div class="line number59 index58 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">CGFontRelease(fontRef);</code></div><div class="line number60 index59 alt1"><code class="js plain">}</code></div><div class="line number61 index60 alt2"><code class="js plain">@end</code></div></div></td></tr></tbody></table></div></div><p>如果你运行代码，你会发现文本并没有像素化，而我们也没有设置contentsScale属性。把CATextLayer作为宿主图层的另一好处就是视图自动设置了contentsScale属性。</p><p>在这个简单的例子中，我们只是实现了UILabel的一部分风格和布局属性，不过稍微再改进一下我们就可以创建一个支持UILabel所有功能甚至更多功能的LayerLabel类（你可以在一些线上的开源项目中找到）。</p><p>如果你打算支持iOS 6及以上，基于CATextLayer的标签可能就有有些局限性。但是总得来说，如果想在app里面充分利用CALayer子类，用+layerClass来创建基于不同图层的视图是一个简单可复用的方法。</p><p><span style="color: rgb(149, 55, 52);">CATransformLayer</span></p><p>当我们在构造复杂的3D事物的时候，如果能够组织独立元素就太方便了。比如说，你想创造一个孩子的手臂：你就需要确定哪一部分是孩子的手腕，哪一部分是孩子的前臂，哪一部分是孩子的肘，哪一部分是孩子的上臂，哪一部分是孩子的肩膀等等。</p><p>当然是允许独立地移动每个区域的啦。以肘为指点会移动前臂和手，而不是肩膀。Core Animation图层很容易就可以让你在2D环境下做出这样的层级体系下的变换，但是3D情况下就不太可能，因为所有的图层都把他的孩子都平面化到一个场景中（第五章『变换』有提到）。</p><p>CATransformLayer解决了这个问题，CATransformLayer不同于普通的CALayer，因为它不能显示它自己的内容。只有当存在了一个能作用域子图层的变换它才真正存在。CATransformLayer并不平面化它的子图层，所以它能够用于构造一个层级的3D结构，比如我的手臂示例。</p><p>用代码创建一个手臂需要相当多的代码，所以我就演示得更简单一些吧：在第五章的立方体示例，我们将通过旋转camara来解决图层平面化问题而不是像立方体示例代码中用的sublayerTransform。这是一个非常不错的技巧，但是只能作用域单个对象上，如果你的场景包含两个立方体，那我们就不能用这个技巧单独旋转他们了。</p><p>那么，就让我们来试一试CATransformLayer吧，第一个问题就来了：在第五章，我们是用多个视图来构造了我们的立方体，而不是单独的图层。我们不能在不打乱已有的视图层次的前提下在一个本身不是有寄宿图的图层中放置一个寄宿图图层。我们可以创建一个新的UIView子类寄宿在CATransformLayer（用+layerClass方法）之上。但是，为了简化案例，我们仅仅重建了一个单独的图层，而不是使用视图。这意味着我们不能像第五章一样在立方体表面显示按钮和标签，不过我们现在也用不到这个特性。</p><p>清单6.5就是代码。我们以我们在第五章使用过的相同基本逻辑放置立方体。但是并不像以前那样直接将立方面添加到容器视图的宿主图层，我们将他们放置到一个CATransformLayer中创建一个独立的立方体对象，然后将两个这样的立方体放进容器中。我们随机地给立方面染色以将他们区分开来，这样就不用靠标签或是光亮来区分他们。图6.5是运行结果。</p><p>清单6.5 用CATransformLayer装配一个3D图层体系</p><div><div id="highlighter_809657" class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div><div class="line number37 index36 alt2">37</div><div class="line number38 index37 alt1">38</div><div class="line number39 index38 alt2">39</div><div class="line number40 index39 alt1">40</div><div class="line number41 index40 alt2">41</div><div class="line number42 index41 alt1">42</div><div class="line number43 index42 alt2">43</div><div class="line number44 index43 alt1">44</div><div class="line number45 index44 alt2">45</div><div class="line number46 index45 alt1">46</div><div class="line number47 index46 alt2">47</div><div class="line number48 index47 alt1">48</div><div class="line number49 index48 alt2">49</div><div class="line number50 index49 alt1">50</div><div class="line number51 index50 alt2">51</div><div class="line number52 index51 alt1">52</div><div class="line number53 index52 alt2">53</div><div class="line number54 index53 alt1">54</div><div class="line number55 index54 alt2">55</div><div class="line number56 index55 alt1">56</div><div class="line number57 index56 alt2">57</div><div class="line number58 index57 alt1">58</div><div class="line number59 index58 alt2">59</div><div class="line number60 index59 alt1">60</div><div class="line number61 index60 alt2">61</div><div class="line number62 index61 alt1">62</div><div class="line number63 index62 alt2">63</div><div class="line number64 index63 alt1">64</div><div class="line number65 index64 alt2">65</div><div class="line number66 index65 alt1">66</div><div class="line number67 index66 alt2">67</div><div class="line number68 index67 alt1">68</div><div class="line number69 index68 alt2">69</div><div class="line number70 index69 alt1">70</div><div class="line number71 index70 alt2">71</div><div class="line number72 index71 alt1">72</div><div class="line number73 index72 alt2">73</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js plain">@interface&nbsp;ViewController&nbsp;()</code></div><div class="line number2 index1 alt1"><code class="js plain">@property&nbsp;(nonatomic,&nbsp;weak)&nbsp;IBOutlet&nbsp;UIView&nbsp;*containerView;</code></div><div class="line number3 index2 alt2"><code class="js plain">@end</code></div><div class="line number4 index3 alt1"><code class="js plain">@implementation&nbsp;ViewController</code></div><div class="line number5 index4 alt2"><code class="js plain">-&nbsp;(CALayer&nbsp;*)faceWithTransform:(CATransform3D)transform</code></div><div class="line number6 index5 alt1"><code class="js plain">{</code></div><div class="line number7 index6 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//create&nbsp;cube&nbsp;face&nbsp;layer</code></div><div class="line number8 index7 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">CALayer&nbsp;*face&nbsp;=&nbsp;[CALayer&nbsp;layer];</code></div><div class="line number9 index8 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">face.frame&nbsp;=&nbsp;CGRectMake(-50,&nbsp;-50,&nbsp;100,&nbsp;100);</code></div><div class="line number10 index9 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//apply&nbsp;a&nbsp;random&nbsp;color</code></div><div class="line number11 index10 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">CGFloat&nbsp;red&nbsp;=&nbsp;(rand()&nbsp;/&nbsp;(double)INT_MAX);</code></div><div class="line number12 index11 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">CGFloat&nbsp;green&nbsp;=&nbsp;(rand()&nbsp;/&nbsp;(double)INT_MAX);</code></div><div class="line number13 index12 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">CGFloat&nbsp;blue&nbsp;=&nbsp;(rand()&nbsp;/&nbsp;(double)INT_MAX);</code></div><div class="line number14 index13 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">face.backgroundColor&nbsp;=&nbsp;[UIColor&nbsp;colorWithRed:red&nbsp;green:green&nbsp;blue:blue&nbsp;alpha:1.0].CGColor;</code></div><div class="line number15 index14 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">?</code><code class="js comments">//apply&nbsp;the&nbsp;transform&nbsp;and&nbsp;return</code></div><div class="line number16 index15 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">face.transform&nbsp;=&nbsp;transform;</code></div><div class="line number17 index16 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js keyword">return</code>&nbsp;<code class="js plain">face;</code></div><div class="line number18 index17 alt1"><code class="js plain">}</code></div><div class="line number19 index18 alt2"><code class="js plain">-&nbsp;(CALayer&nbsp;*)cubeWithTransform:(CATransform3D)transform</code></div><div class="line number20 index19 alt1"><code class="js plain">{</code></div><div class="line number21 index20 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//create&nbsp;cube&nbsp;layer</code></div><div class="line number22 index21 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">CATransformLayer&nbsp;*cube&nbsp;=&nbsp;[CATransformLayer&nbsp;layer];</code></div><div class="line number23 index22 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//add&nbsp;cube&nbsp;face&nbsp;1</code></div><div class="line number24 index23 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">CATransform3D&nbsp;ct&nbsp;=&nbsp;CATransform3DMakeTranslation(0,&nbsp;0,&nbsp;50);</code></div><div class="line number25 index24 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">[cube&nbsp;addSublayer:[self&nbsp;faceWithTransform:ct]];</code></div><div class="line number26 index25 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//add&nbsp;cube&nbsp;face&nbsp;2</code></div><div class="line number27 index26 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">ct&nbsp;=&nbsp;CATransform3DMakeTranslation(50,&nbsp;0,&nbsp;0);</code></div><div class="line number28 index27 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">ct&nbsp;=&nbsp;CATransform3DRotate(ct,&nbsp;M_PI_2,&nbsp;0,&nbsp;1,&nbsp;0);</code></div><div class="line number29 index28 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">[cube&nbsp;addSublayer:[self&nbsp;faceWithTransform:ct]];</code></div><div class="line number30 index29 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//add&nbsp;cube&nbsp;face&nbsp;3</code></div><div class="line number31 index30 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">ct&nbsp;=&nbsp;CATransform3DMakeTranslation(0,&nbsp;-50,&nbsp;0);</code></div><div class="line number32 index31 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">ct&nbsp;=&nbsp;CATransform3DRotate(ct,&nbsp;M_PI_2,&nbsp;1,&nbsp;0,&nbsp;0);</code></div><div class="line number33 index32 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">[cube&nbsp;addSublayer:[self&nbsp;faceWithTransform:ct]];</code></div><div class="line number34 index33 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//add&nbsp;cube&nbsp;face&nbsp;4</code></div><div class="line number35 index34 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">ct&nbsp;=&nbsp;CATransform3DMakeTranslation(0,&nbsp;50,&nbsp;0);</code></div><div class="line number36 index35 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">ct&nbsp;=&nbsp;CATransform3DRotate(ct,&nbsp;-M_PI_2,&nbsp;1,&nbsp;0,&nbsp;0);</code></div><div class="line number37 index36 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">[cube&nbsp;addSublayer:[self&nbsp;faceWithTransform:ct]];</code></div><div class="line number38 index37 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//add&nbsp;cube&nbsp;face&nbsp;5</code></div><div class="line number39 index38 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">ct&nbsp;=&nbsp;CATransform3DMakeTranslation(-50,&nbsp;0,&nbsp;0);</code></div><div class="line number40 index39 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">ct&nbsp;=&nbsp;CATransform3DRotate(ct,&nbsp;-M_PI_2,&nbsp;0,&nbsp;1,&nbsp;0);</code></div><div class="line number41 index40 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">[cube&nbsp;addSublayer:[self&nbsp;faceWithTransform:ct]];</code></div><div class="line number42 index41 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//add&nbsp;cube&nbsp;face&nbsp;6</code></div><div class="line number43 index42 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">ct&nbsp;=&nbsp;CATransform3DMakeTranslation(0,&nbsp;0,&nbsp;-50);</code></div><div class="line number44 index43 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">ct&nbsp;=&nbsp;CATransform3DRotate(ct,&nbsp;M_PI,&nbsp;0,&nbsp;1,&nbsp;0);</code></div><div class="line number45 index44 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">[cube&nbsp;addSublayer:[self&nbsp;faceWithTransform:ct]];</code></div><div class="line number46 index45 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//center&nbsp;the&nbsp;cube&nbsp;layer&nbsp;within&nbsp;the&nbsp;container</code></div><div class="line number47 index46 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">CGSize&nbsp;containerSize&nbsp;=&nbsp;self.containerView.bounds.size;</code></div><div class="line number48 index47 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">cube.position&nbsp;=&nbsp;CGPointMake(containerSize.width&nbsp;/&nbsp;2.0,&nbsp;containerSize.height&nbsp;/&nbsp;2.0);</code></div><div class="line number49 index48 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//apply&nbsp;the&nbsp;transform&nbsp;and&nbsp;return</code></div><div class="line number50 index49 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">cube.transform&nbsp;=&nbsp;transform;</code></div><div class="line number51 index50 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js keyword">return</code>&nbsp;<code class="js plain">cube;</code></div><div class="line number52 index51 alt1"><code class="js plain">}</code></div><div class="line number53 index52 alt2"><code class="js plain">-&nbsp;(void)viewDidLoad</code></div><div class="line number54 index53 alt1"><code class="js plain">{?</code></div><div class="line number55 index54 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">[</code><code class="js keyword">super</code>&nbsp;<code class="js plain">viewDidLoad];</code></div><div class="line number56 index55 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//set&nbsp;up&nbsp;the&nbsp;perspective&nbsp;transform</code></div><div class="line number57 index56 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">CATransform3D&nbsp;pt&nbsp;=&nbsp;CATransform3DIdentity;</code></div><div class="line number58 index57 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">pt.m34&nbsp;=&nbsp;-1.0&nbsp;/&nbsp;500.0;</code></div><div class="line number59 index58 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">self.containerView.layer.sublayerTransform&nbsp;=&nbsp;pt;</code></div><div class="line number60 index59 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//set&nbsp;up&nbsp;the&nbsp;transform&nbsp;for&nbsp;cube&nbsp;1&nbsp;and&nbsp;add&nbsp;it</code></div><div class="line number61 index60 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">CATransform3D&nbsp;c1t&nbsp;=&nbsp;CATransform3DIdentity;</code></div><div class="line number62 index61 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">c1t&nbsp;=&nbsp;CATransform3DTranslate(c1t,&nbsp;-100,&nbsp;0,&nbsp;0);</code></div><div class="line number63 index62 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">CALayer&nbsp;*cube1&nbsp;=&nbsp;[self&nbsp;cubeWithTransform:c1t];</code></div><div class="line number64 index63 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">[self.containerView.layer&nbsp;addSublayer:cube1];</code></div><div class="line number65 index64 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//set&nbsp;up&nbsp;the&nbsp;transform&nbsp;for&nbsp;cube&nbsp;2&nbsp;and&nbsp;add&nbsp;it</code></div><div class="line number66 index65 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">CATransform3D&nbsp;c2t&nbsp;=&nbsp;CATransform3DIdentity;</code></div><div class="line number67 index66 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">c2t&nbsp;=&nbsp;CATransform3DTranslate(c2t,&nbsp;100,&nbsp;0,&nbsp;0);</code></div><div class="line number68 index67 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">c2t&nbsp;=&nbsp;CATransform3DRotate(c2t,&nbsp;-M_PI_4,&nbsp;1,&nbsp;0,&nbsp;0);</code></div><div class="line number69 index68 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">c2t&nbsp;=&nbsp;CATransform3DRotate(c2t,&nbsp;-M_PI_4,&nbsp;0,&nbsp;1,&nbsp;0);</code></div><div class="line number70 index69 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">CALayer&nbsp;*cube2&nbsp;=&nbsp;[self&nbsp;cubeWithTransform:c2t];</code></div><div class="line number71 index70 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">[self.containerView.layer&nbsp;addSublayer:cube2];</code></div><div class="line number72 index71 alt1"><code class="js plain">}</code></div><div class="line number73 index72 alt2"><code class="js plain">@end</code></div></div></td></tr></tbody></table></div></div><p style="text-align:center"><img src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/1420356839186057.png" title="1420356839186057.png" alt="6.5.png" style="width: 484px; height: 256px;"></p><p>图6.5 同一视角下的俩不同变换的立方体</p><p><strong>CAGradientLayer</strong></p><p>CAGradientLayer是用来生成两种或更多颜色平滑渐变的。用Core Graphics复制一个CAGradientLayer并将内容绘制到一个普通图层的寄宿图也是有可能的，但是CAGradientLayer的真正好处在于绘制使用了硬件加速。</p><p><span style="color: rgb(149, 55, 52);">基础渐变</span></p><p>我们将从一个简单的红变蓝的对角线渐变开始（见清单6.6）.这些渐变色彩放在一个数组中，并赋给colors属性。这个数组成员接受CGColorRef类型的值（并不是从NSObject派生而来），所以我们要用通过bridge转换以确保编译正常。</p><p>CAGradientLayer也有startPoint和endPoint属性，他们决定了渐变的方向。这两个参数是以单位坐标系进行的定义，所以左上角坐标是{0, 0}，右下角坐标是{1, 1}。代码运行结果如图6.6</p><p>清单6.6 简单的两种颜色的对角线渐变</p><div><div id="highlighter_684976" class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js plain">@interface&nbsp;ViewController&nbsp;()</code></div><div class="line number2 index1 alt1"><code class="js plain">@property&nbsp;(nonatomic,&nbsp;weak)&nbsp;IBOutlet&nbsp;UIView&nbsp;*containerView;</code></div><div class="line number3 index2 alt2"><code class="js plain">@end</code></div><div class="line number4 index3 alt1"><code class="js plain">@implementation&nbsp;ViewController</code></div><div class="line number5 index4 alt2"><code class="js plain">-&nbsp;(void)viewDidLoad</code></div><div class="line number6 index5 alt1"><code class="js plain">{</code></div><div class="line number7 index6 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">[</code><code class="js keyword">super</code>&nbsp;<code class="js plain">viewDidLoad];</code></div><div class="line number8 index7 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//create&nbsp;gradient&nbsp;layer&nbsp;and&nbsp;add&nbsp;it&nbsp;to&nbsp;our&nbsp;container&nbsp;view</code></div><div class="line number9 index8 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">CAGradientLayer&nbsp;*gradientLayer&nbsp;=&nbsp;[CAGradientLayer&nbsp;layer];</code></div><div class="line number10 index9 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">gradientLayer.frame&nbsp;=&nbsp;self.containerView.bounds;</code></div><div class="line number11 index10 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">[self.containerView.layer&nbsp;addSublayer:gradientLayer];</code></div><div class="line number12 index11 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//set&nbsp;gradient&nbsp;colors</code></div><div class="line number13 index12 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">gradientLayer.colors&nbsp;=&nbsp;@[(__bridge&nbsp;id)[UIColor&nbsp;redColor].CGColor,&nbsp;(__bridge&nbsp;id)[UIColor&nbsp;blueColor].CGColor];</code></div><div class="line number14 index13 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//set&nbsp;gradient&nbsp;start&nbsp;and&nbsp;end&nbsp;points</code></div><div class="line number15 index14 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">gradientLayer.startPoint&nbsp;=&nbsp;CGPointMake(0,&nbsp;0);</code></div><div class="line number16 index15 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">gradientLayer.endPoint&nbsp;=&nbsp;CGPointMake(1,&nbsp;1);</code></div><div class="line number17 index16 alt2"><code class="js plain">}</code></div><div class="line number18 index17 alt1"><code class="js plain">@end</code></div></div></td></tr></tbody></table></div></div><p style="text-align:center"><img src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/1420357160323097.png" title="1420357160323097.png" alt="6.6.png" style="width: 487px; height: 254px;"></p><p>图6.6 用CAGradientLayer实现简单的两种颜色的对角线渐变</p><p><span style="color: rgb(149, 55, 52);">多重渐变</span></p><p>如果你愿意，colors属性可以包含很多颜色，所以创建一个彩虹一样的多重渐变也是很简单的。默认情况下，这些颜色在空间上均匀地被渲染，但是我们可以用locations属性来调整空间。locations属性是一个浮点数值的数组（以NSNumber包装）。这些浮点数定义了colors属性中每个不同颜色的位置，同样的，也是以单位坐标系进行标定。0.0代表着渐变的开始，1.0代表着结束。</p><p>locations数组并不是强制要求的，但是如果你给它赋值了就一定要确保locations的数组大小和colors数组大小一定要相同，否则你将会得到一个空白的渐变。</p><p>清单6.7展示了一个基于清单6.6的对角线渐变的代码改造。现在变成了从红到黄最后到绿色的渐变。locations数组指定了0.0，0.25和0.5三个数值，这样这三个渐变就有点像挤在了左上角。（如图6.7）.</p><p>清单6.7 在渐变上使用locations</p><div><div id="highlighter_628491" class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js plain">-&nbsp;(void)viewDidLoad&nbsp;{</code></div><div class="line number2 index1 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">[</code><code class="js keyword">super</code>&nbsp;<code class="js plain">viewDidLoad];</code></div><div class="line number3 index2 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//create&nbsp;gradient&nbsp;layer&nbsp;and&nbsp;add&nbsp;it&nbsp;to&nbsp;our&nbsp;container&nbsp;view</code></div><div class="line number4 index3 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">CAGradientLayer&nbsp;*gradientLayer&nbsp;=&nbsp;[CAGradientLayer&nbsp;layer];</code></div><div class="line number5 index4 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">gradientLayer.frame&nbsp;=&nbsp;self.containerView.bounds;</code></div><div class="line number6 index5 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">[self.containerView.layer&nbsp;addSublayer:gradientLayer];</code></div><div class="line number7 index6 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//set&nbsp;gradient&nbsp;colors</code></div><div class="line number8 index7 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">gradientLayer.colors&nbsp;=&nbsp;@[(__bridge&nbsp;id)[UIColor&nbsp;redColor].CGColor,&nbsp;(__bridge&nbsp;id&nbsp;[UIColor&nbsp;yellowColor].CGColor,&nbsp;(__bridge&nbsp;id)[UIColor&nbsp;greenColor].CGColor];</code></div><div class="line number9 index8 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//set&nbsp;locations</code></div><div class="line number10 index9 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">gradientLayer.locations&nbsp;=&nbsp;@[@0.0,&nbsp;@0.25,&nbsp;@0.5];</code></div><div class="line number11 index10 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//set&nbsp;gradient&nbsp;start&nbsp;and&nbsp;end&nbsp;points</code></div><div class="line number12 index11 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">gradientLayer.startPoint&nbsp;=&nbsp;CGPointMake(0,&nbsp;0);</code></div><div class="line number13 index12 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">gradientLayer.endPoint&nbsp;=&nbsp;CGPointMake(1,&nbsp;1);</code></div><div class="line number14 index13 alt1"><code class="js plain">}</code></div></div></td></tr></tbody></table></div></div><p style="text-align:center"><img src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/1420357200543954.png" title="1420357200543954.png" alt="6.7.png" style="width: 490px; height: 263px;"></p><p>图6.7 用locations构造偏移至左上角的三色渐变</p><p><strong>CAReplicatorLayer</strong></p><p>CAReplicatorLayer的目的是为了高效生成许多相似的图层。它会绘制一个或多个图层的子图层，并在每个复制体上应用不同的变换。看上去演示能够更加解释这些，我们来写个例子吧。</p><p><span style="color: rgb(149, 55, 52);">重复图层（Repeating Layers）</span></p><p>清单6.8中，我们在屏幕的中间创建了一个小白色方块图层，然后用CAReplicatorLayer生成十个图层组成一个圆圈。instanceCount属性指定了图层需要重复多少次。instanceTransform指定了一个CATransform3D3D变换（这种情况下，下一图层的位移和旋转将会移动到圆圈的下一个点）。</p><p>变换是逐步增加的，每个实例都是相对于前一实例布局。这就是为什么这些复制体最终不会出现在同意位置上，图6.8是代码运行结果。</p><p>清单6.8 用CAReplicatorLayer重复图层</p><div><div id="highlighter_387829" class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js plain">@interface&nbsp;ViewController&nbsp;()</code></div><div class="line number2 index1 alt1"><code class="js plain">@property&nbsp;(nonatomic,&nbsp;weak)&nbsp;IBOutlet&nbsp;UIView&nbsp;*containerView;</code></div><div class="line number3 index2 alt2"><code class="js plain">@end</code></div><div class="line number4 index3 alt1"><code class="js plain">@implementation&nbsp;ViewController</code></div><div class="line number5 index4 alt2"><code class="js plain">-&nbsp;(void)viewDidLoad</code></div><div class="line number6 index5 alt1"><code class="js plain">{</code></div><div class="line number7 index6 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">[</code><code class="js keyword">super</code>&nbsp;<code class="js plain">viewDidLoad];</code></div><div class="line number8 index7 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//create&nbsp;a&nbsp;replicator&nbsp;layer&nbsp;and&nbsp;add&nbsp;it&nbsp;to&nbsp;our&nbsp;view</code></div><div class="line number9 index8 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">CAReplicatorLayer&nbsp;*replicator&nbsp;=&nbsp;[CAReplicatorLayer&nbsp;layer];</code></div><div class="line number10 index9 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">replicator.frame&nbsp;=&nbsp;self.containerView.bounds;</code></div><div class="line number11 index10 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">[self.containerView.layer&nbsp;addSublayer:replicator];</code></div><div class="line number12 index11 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//configure&nbsp;the&nbsp;replicator</code></div><div class="line number13 index12 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">replicator.instanceCount&nbsp;=&nbsp;10;</code></div><div class="line number14 index13 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//apply&nbsp;a&nbsp;transform&nbsp;for&nbsp;each&nbsp;instance</code></div><div class="line number15 index14 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">CATransform3D&nbsp;transform&nbsp;=&nbsp;CATransform3DIdentity;</code></div><div class="line number16 index15 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">transform&nbsp;=&nbsp;CATransform3DTranslate(transform,&nbsp;0,&nbsp;200,&nbsp;0);</code></div><div class="line number17 index16 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">transform&nbsp;=&nbsp;CATransform3DRotate(transform,&nbsp;M_PI&nbsp;/&nbsp;5.0,&nbsp;0,&nbsp;0,&nbsp;1);</code></div><div class="line number18 index17 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">transform&nbsp;=&nbsp;CATransform3DTranslate(transform,&nbsp;0,&nbsp;-200,&nbsp;0);</code></div><div class="line number19 index18 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">replicator.instanceTransform&nbsp;=&nbsp;transform;</code></div><div class="line number20 index19 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//apply&nbsp;a&nbsp;color&nbsp;shift&nbsp;for&nbsp;each&nbsp;instance</code></div><div class="line number21 index20 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">replicator.instanceBlueOffset&nbsp;=&nbsp;-0.1;</code></div><div class="line number22 index21 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">replicator.instanceGreenOffset&nbsp;=&nbsp;-0.1;</code></div><div class="line number23 index22 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//create&nbsp;a&nbsp;sublayer&nbsp;and&nbsp;place&nbsp;it&nbsp;inside&nbsp;the&nbsp;replicator</code></div><div class="line number24 index23 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">CALayer&nbsp;*layer&nbsp;=&nbsp;[CALayer&nbsp;layer];</code></div><div class="line number25 index24 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">layer.frame&nbsp;=&nbsp;CGRectMake(100.0f,&nbsp;100.0f,&nbsp;100.0f,&nbsp;100.0f);</code></div><div class="line number26 index25 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">layer.backgroundColor&nbsp;=&nbsp;[UIColor&nbsp;whiteColor].CGColor;</code></div><div class="line number27 index26 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">[replicator&nbsp;addSublayer:layer];</code></div><div class="line number28 index27 alt1"><code class="js plain">}</code></div><div class="line number29 index28 alt2"><code class="js plain">@end</code></div></div></td></tr></tbody></table></div></div><p style="text-align:center"><img src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/1420357246580331.png" title="1420357246580331.png" alt="6.8.png" style="width: 485px; height: 248px;"></p><p>图6.8 用CAReplicatorLayer创建一圈图层</p><p>注意到当图层在重复的时候，他们的颜色也在变化：这是用instanceBlueOffset和instanceGreenOffset属性实现的。通过逐步减少蓝色和绿色通道，我们逐渐将图层颜色转换成了红色。这个复制效果看起来很酷，但是CAReplicatorLayer真正应用到实际程序上的场景比如：一个游戏中导弹的轨迹云，或者粒子爆炸（尽管iOS 5已经引入了CAEmitterLayer，它更适合创建任意的粒子效果）。除此之外，还有一个实际应用是：反射。</p><p><span style="color: rgb(149, 55, 52);">反射</span></p><p>使用CAReplicatorLayer并应用一个负比例变换于一个复制图层，你就可以创建指定视图（或整个视图层次）内容的镜像图片，这样就创建了一个实时的『反射』效果。让我们来尝试实现这个创意：指定一个继承于UIView的ReflectionView，它会自动产生内容的反射效果。实现这个效果的代码很简单（见清单6.9），实际上用ReflectionView实现这个效果会更简单，我们只需要把ReflectionView的实例放置于Interface Builder（见图6.9），它就会实时生成子视图的反射，而不需要别的代码（见图6.10）.</p><p>清单6.9 用CAReplicatorLayer自动绘制反射</p><div><div id="highlighter_762272" class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js preprocessor">#import&nbsp;"ReflectionView.h"</code></div><div class="line number2 index1 alt1"><code class="js preprocessor">#import&nbsp;@implementation&nbsp;ReflectionView</code></div><div class="line number3 index2 alt2"><code class="js plain">+&nbsp;(Class)layerClass</code></div><div class="line number4 index3 alt1"><code class="js plain">{</code></div><div class="line number5 index4 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js keyword">return</code>&nbsp;<code class="js plain">[CAReplicatorLayer&nbsp;class];</code></div><div class="line number6 index5 alt1"><code class="js plain">}</code></div><div class="line number7 index6 alt2"><code class="js plain">-&nbsp;(void)setUp</code></div><div class="line number8 index7 alt1"><code class="js plain">{</code></div><div class="line number9 index8 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//configure&nbsp;replicator</code></div><div class="line number10 index9 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">CAReplicatorLayer&nbsp;*layer&nbsp;=&nbsp;(CAReplicatorLayer&nbsp;*)self.layer;</code></div><div class="line number11 index10 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">layer.instanceCount&nbsp;=&nbsp;2;</code></div><div class="line number12 index11 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//move&nbsp;reflection&nbsp;instance&nbsp;below&nbsp;original&nbsp;and&nbsp;flip&nbsp;vertically</code></div><div class="line number13 index12 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">CATransform3D&nbsp;transform&nbsp;=&nbsp;CATransform3DIdentity;</code></div><div class="line number14 index13 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">CGFloat&nbsp;verticalOffset&nbsp;=&nbsp;self.bounds.size.height&nbsp;+&nbsp;2;</code></div><div class="line number15 index14 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">transform&nbsp;=&nbsp;CATransform3DTranslate(transform,&nbsp;0,&nbsp;verticalOffset,&nbsp;0);</code></div><div class="line number16 index15 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">transform&nbsp;=&nbsp;CATransform3DScale(transform,&nbsp;1,&nbsp;-1,&nbsp;0);</code></div><div class="line number17 index16 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">layer.instanceTransform&nbsp;=&nbsp;transform;</code></div><div class="line number18 index17 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//reduce&nbsp;alpha&nbsp;of&nbsp;reflection&nbsp;layer</code></div><div class="line number19 index18 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">layer.instanceAlphaOffset&nbsp;=&nbsp;-0.6;</code></div><div class="line number20 index19 alt1"><code class="js plain">}</code></div><div class="line number21 index20 alt2"><code class="js plain">?</code></div><div class="line number22 index21 alt1"><code class="js plain">-&nbsp;(id)initWithFrame:(CGRect)frame</code></div><div class="line number23 index22 alt2"><code class="js plain">{</code></div><div class="line number24 index23 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//this&nbsp;is&nbsp;called&nbsp;when&nbsp;view&nbsp;is&nbsp;created&nbsp;in&nbsp;code</code></div><div class="line number25 index24 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js keyword">if</code>&nbsp;<code class="js plain">((self&nbsp;=&nbsp;[</code><code class="js keyword">super</code>&nbsp;<code class="js plain">initWithFrame:frame]))&nbsp;{</code></div><div class="line number26 index25 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">[self&nbsp;setUp];</code></div><div class="line number27 index26 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">}</code></div><div class="line number28 index27 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js keyword">return</code>&nbsp;<code class="js plain">self;</code></div><div class="line number29 index28 alt2"><code class="js plain">}</code></div><div class="line number30 index29 alt1"><code class="js plain">-&nbsp;(void)awakeFromNib</code></div><div class="line number31 index30 alt2"><code class="js plain">{</code></div><div class="line number32 index31 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//this&nbsp;is&nbsp;called&nbsp;when&nbsp;view&nbsp;is&nbsp;created&nbsp;from&nbsp;a&nbsp;nib</code></div><div class="line number33 index32 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">[self&nbsp;setUp];</code></div><div class="line number34 index33 alt1"><code class="js plain">}</code></div><div class="line number35 index34 alt2"><code class="js plain">@end</code></div></div></td></tr></tbody></table></div></div><p style="text-align:center"><img src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/1420357299316359.jpg" title="1420357299316359.jpg" alt="6.9.jpg" style="width: 484px; height: 271px;"></p><p>图6.9 在Interface Builder中使用ReflectionView</p><p style="text-align:center"><img src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/1420357316549034.png" title="1420357316549034.png" alt="6.10.png" style="width: 493px; height: 253px;"></p><p>图6.10 ReflectionView自动实时产生反射效果。</p><p>开源代码ReflectionView完成了一个自适应的渐变淡出效果（用CAGradientLayer和图层蒙板实现），代码见 https://github.com/nicklockwood/ReflectionView</p><p><strong>CAScrollLayer</strong></p><p>对于一个未转换的图层，它的bounds和它的frame是一样的，frame属性是由bounds属性自动计算而出的，所以更改任意一个值都会更新其他值。</p><p>但是如果你只想显示一个大图层里面的一小部分呢。比如说，你可能有一个很大的图片，你希望用户能够随意滑动，或者是一个数据或文本的长列表。在一个典型的iOS应用中，你可能会用到UITableView或是UIScrollView，但是对于独立的图层来说，什么会等价于刚刚提到的UITableView和UIScrollView呢？</p><p>在第二章中，我们探索了图层的contentsRect属性的用法，它的确是能够解决在图层中小地方显示大图片的解决方法。但是如果你的图层包含子图层那它就不是一个非常好的解决方案，因为，这样做的话每次你想『滑动』可视区域的时候，你就需要手工重新计算并更新所有的子图层位置。</p><p>这个时候就需要CAScrollLayer了。CAScrollLayer有一个-scrollToPoint:方法，它自动适应bounds的原点以便图层内容出现在滑动的地方。注意，这就是它做的所有事情。前面提到过，Core Animation并不处理用户输入，所以CAScrollLayer并不负责将触摸事件转换为滑动事件，既不渲染滚动条，也不实现任何iOS指定行为例如滑动反弹（当视图滑动超多了它的边界的将会反弹回正确的地方）。</p><p>让我们来用CAScrollLayer来常见一个基本的UIScrollView替代品。我们将会用CAScrollLayer作为视图的宿主图层，并创建一个自定义的UIView，然后用UIPanGestureRecognizer实现触摸事件响应。这段代码见清单6.10. 图6.11是运行效果：ScrollView显示了一个大于它的frame的UIImageView。</p><p>清单6.10 用CAScrollLayer实现滑动视图</p><div><div id="highlighter_32512" class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div><div class="line number37 index36 alt2">37</div><div class="line number38 index37 alt1">38</div><div class="line number39 index38 alt2">39</div><div class="line number40 index39 alt1">40</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js preprocessor">#import&nbsp;"ScrollView.h"</code></div><div class="line number2 index1 alt1"><code class="js preprocessor">#import&nbsp;&nbsp;@implementation&nbsp;ScrollView</code></div><div class="line number3 index2 alt2"><code class="js plain">+&nbsp;(Class)layerClass</code></div><div class="line number4 index3 alt1"><code class="js plain">{</code></div><div class="line number5 index4 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js keyword">return</code>&nbsp;<code class="js plain">[CAScrollLayer&nbsp;class];</code></div><div class="line number6 index5 alt1"><code class="js plain">}</code></div><div class="line number7 index6 alt2"><code class="js plain">-&nbsp;(void)setUp</code></div><div class="line number8 index7 alt1"><code class="js plain">{</code></div><div class="line number9 index8 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//enable&nbsp;clipping</code></div><div class="line number10 index9 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">self.layer.masksToBounds&nbsp;=&nbsp;YES;</code></div><div class="line number11 index10 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//attach&nbsp;pan&nbsp;gesture&nbsp;recognizer</code></div><div class="line number12 index11 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">UIPanGestureRecognizer&nbsp;*recognizer&nbsp;=&nbsp;nil;</code></div><div class="line number13 index12 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">recognizer&nbsp;=&nbsp;[[UIPanGestureRecognizer&nbsp;alloc]&nbsp;initWithTarget:self&nbsp;action:@selector(pan:)];</code></div><div class="line number14 index13 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">[self&nbsp;addGestureRecognizer:recognizer];</code></div><div class="line number15 index14 alt2"><code class="js plain">}</code></div><div class="line number16 index15 alt1"><code class="js plain">-&nbsp;(id)initWithFrame:(CGRect)frame</code></div><div class="line number17 index16 alt2"><code class="js plain">{</code></div><div class="line number18 index17 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//this&nbsp;is&nbsp;called&nbsp;when&nbsp;view&nbsp;is&nbsp;created&nbsp;in&nbsp;code</code></div><div class="line number19 index18 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js keyword">if</code>&nbsp;<code class="js plain">((self&nbsp;=&nbsp;[</code><code class="js keyword">super</code>&nbsp;<code class="js plain">initWithFrame:frame]))&nbsp;{</code></div><div class="line number20 index19 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">[self&nbsp;setUp];</code></div><div class="line number21 index20 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">}</code></div><div class="line number22 index21 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js keyword">return</code>&nbsp;<code class="js plain">self;</code></div><div class="line number23 index22 alt2"><code class="js plain">}</code></div><div class="line number24 index23 alt1"><code class="js plain">-&nbsp;(void)awakeFromNib&nbsp;{</code></div><div class="line number25 index24 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//this&nbsp;is&nbsp;called&nbsp;when&nbsp;view&nbsp;is&nbsp;created&nbsp;from&nbsp;a&nbsp;nib</code></div><div class="line number26 index25 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">[self&nbsp;setUp];</code></div><div class="line number27 index26 alt2"><code class="js plain">}</code></div><div class="line number28 index27 alt1"><code class="js plain">-&nbsp;(void)pan:(UIPanGestureRecognizer&nbsp;*)recognizer</code></div><div class="line number29 index28 alt2"><code class="js plain">{</code></div><div class="line number30 index29 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//get&nbsp;the&nbsp;offset&nbsp;by&nbsp;subtracting&nbsp;the&nbsp;pan&nbsp;gesture</code></div><div class="line number31 index30 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//translation&nbsp;from&nbsp;the&nbsp;current&nbsp;bounds&nbsp;origin</code></div><div class="line number32 index31 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">CGPoint&nbsp;offset&nbsp;=&nbsp;self.bounds.origin;</code></div><div class="line number33 index32 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">offset.x&nbsp;-=&nbsp;[recognizer&nbsp;translationInView:self].x;</code></div><div class="line number34 index33 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">offset.y&nbsp;-=&nbsp;[recognizer&nbsp;translationInView:self].y;</code></div><div class="line number35 index34 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//scroll&nbsp;the&nbsp;layer</code></div><div class="line number36 index35 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">[(CAScrollLayer&nbsp;*)self.layer&nbsp;scrollToPoint:offset];</code></div><div class="line number37 index36 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//reset&nbsp;the&nbsp;pan&nbsp;gesture&nbsp;translation</code></div><div class="line number38 index37 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">[recognizer&nbsp;setTranslation:CGPointZero&nbsp;inView:self];</code></div><div class="line number39 index38 alt2"><code class="js plain">}</code></div><div class="line number40 index39 alt1"><code class="js plain">@end</code></div></div></td></tr></tbody></table></div></div><p>图6.11 用UIScrollView创建一个凑合的滑动视图</p><p>不同于UIScrollView，我们定制的滑动视图类并没有实现任何形式的边界检查（bounds checking）。图层内容极有可能滑出视图的边界并无限滑下去。CAScrollLayer并没有等同于UIScrollView中contentSize的属性，所以当CAScrollLayer滑动的时候完全没有一个全局的可滑动区域的概念，也无法自适应它的边界原点至你指定的值。它之所以不能自适应边界大小是因为它不需要，内容完全可以超过边界。</p><p>那你一定会奇怪用CAScrollLayer的意义到底何在，因为你可以简单地用一个普通的CALayer然后手动适应边界原点啊。真相其实并不复杂，UIScrollView并没有用CAScrollLayer，事实上，就是简单的通过直接操作图层边界来实现滑动。</p><p>CAScrollLayer有一个潜在的有用特性。如果你查看CAScrollLayer的头文件，你就会注意到有一个扩展分类实现了一些方法和属性：</p><div><div id="highlighter_107359" class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js plain">-&nbsp;(void)scrollPoint:(CGPoint)p;</code></div><div class="line number2 index1 alt1"><code class="js plain">-&nbsp;(void)scrollRectToVisible:(CGRect)r;</code></div><div class="line number3 index2 alt2"><code class="js plain">@property(readonly)&nbsp;CGRect&nbsp;visibleRect;</code></div></div></td></tr></tbody></table></div></div><p>看到这些方法和属性名，你也许会以为这些方法给每个CALayer实例增加了滑动功能。但是事实上他们只是放置在CAScrollLayer中的图层的实用方法。scrollPoint:方法从图层树中查找并找到第一个可用的CAScrollLayer，然后滑动它使得指定点成为可视的。scrollRectToVisible:方法实现了同样的事情只不过是作用在一个矩形上的。visibleRect属性决定图层（如果存在的话）的哪部分是当前的可视区域。如果你自己实现这些方法就会相对容易明白一点，但是CAScrollLayer帮你省了这些麻烦，所以当涉及到实现图层滑动的时候就可以用上了。</p><p><strong>CATiledLayer</strong></p><p>有些时候你可能需要绘制一个很大的图片，常见的例子就是一个高像素的照片或者是地球表面的详细地图。iOS应用通畅运行在内存受限的设备上，所以读取整个图片到内存中是不明智的。载入大图可能会相当地慢，那些对你看上去比较方便的做法（在主线程调用UIImage的-imageNamed:方法或者-imageWithContentsOfFile:方法）将会阻塞你的用户界面，至少会引起动画卡顿现象。</p><p>能高效绘制在iOS上的图片也有一个大小限制。所有显示在屏幕上的图片最终都会被转化为OpenGL纹理，同时OpenGL有一个最大的纹理尺寸（通常是2048*2048，或4096*4096，这个取决于设备型号）。如果你想在单个纹理中显示一个比这大的图，即便图片已经存在于内存中了，你仍然会遇到很大的性能问题，因为Core Animation强制用CPU处理图片而不是更快的GPU（见第12章『速度的曲调』，和第13章『高效绘图』，它更加详细地解释了软件绘制和硬件绘制）。</p><p>CATiledLayer为载入大图造成的性能问题提供了一个解决方案：将大图分解成小片然后将他们单独按需载入。让我们用实验来证明一下。</p><p><span style="color: rgb(149, 55, 52);">小片裁剪</span></p><p>这个示例中，我们将会从一个2048*2048分辨率的雪人图片入手。为了能够从CATiledLayer中获益，我们需要把这个图片裁切成许多小一些的图片。你可以通过代码来完成这件事情，但是如果你在运行时读入整个图片并裁切，那CATiledLayer这些所有的性能优点就损失殆尽了。理想情况下来说，最好能够逐个步骤来实现。</p><p>清单6.11 演示了一个简单的Mac OS命令行程序，它用CATiledLayer将一个图片裁剪成小图并存储到不同的文件中。</p><p>清单6.11 裁剪图片成小图的终端程序</p><div><div id="highlighter_534867" class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div><div class="line number37 index36 alt2">37</div><div class="line number38 index37 alt1">38</div><div class="line number39 index38 alt2">39</div><div class="line number40 index39 alt1">40</div><div class="line number41 index40 alt2">41</div><div class="line number42 index41 alt1">42</div><div class="line number43 index42 alt2">43</div><div class="line number44 index43 alt1">44</div><div class="line number45 index44 alt2">45</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js preprocessor">#import&nbsp;int&nbsp;main(int&nbsp;argc,&nbsp;const&nbsp;char&nbsp;*&nbsp;argv[])</code></div><div class="line number2 index1 alt1"><code class="js plain">{</code></div><div class="line number3 index2 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">@autoreleasepool{</code></div><div class="line number4 index3 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">?</code><code class="js comments">//handle&nbsp;incorrect&nbsp;arguments</code></div><div class="line number5 index4 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js keyword">if</code>&nbsp;<code class="js plain">(argc&nbsp;&lt;&nbsp;2)&nbsp;{</code></div><div class="line number6 index5 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">NSLog(@</code><code class="js string">"TileCutter&nbsp;arguments:&nbsp;inputfile"</code><code class="js plain">);</code></div><div class="line number7 index6 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js keyword">return</code>&nbsp;<code class="js plain">0;</code></div><div class="line number8 index7 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">}</code></div><div class="line number9 index8 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//input&nbsp;file</code></div><div class="line number10 index9 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">NSString&nbsp;*inputFile&nbsp;=&nbsp;[NSString&nbsp;stringWithCString:argv[1]&nbsp;encoding:NSUTF8StringEncoding];</code></div><div class="line number11 index10 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//tile&nbsp;size</code></div><div class="line number12 index11 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">CGFloat&nbsp;tileSize&nbsp;=&nbsp;256;&nbsp;</code><code class="js comments">//output&nbsp;path</code></div><div class="line number13 index12 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">NSString&nbsp;*outputPath&nbsp;=&nbsp;[inputFile&nbsp;stringByDeletingPathExtension];</code></div><div class="line number14 index13 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//load&nbsp;image</code></div><div class="line number15 index14 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">NSImage&nbsp;*image&nbsp;=&nbsp;[[NSImage&nbsp;alloc]&nbsp;initWithContentsOfFile:inputFile];</code></div><div class="line number16 index15 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">NSSize&nbsp;size&nbsp;=&nbsp;[image&nbsp;size];</code></div><div class="line number17 index16 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">NSArray&nbsp;*representations&nbsp;=&nbsp;[image&nbsp;representations];</code></div><div class="line number18 index17 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js keyword">if</code>&nbsp;<code class="js plain">([representations&nbsp;count]){</code></div><div class="line number19 index18 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">NSBitmapImageRep&nbsp;*representation&nbsp;=&nbsp;representations[0];</code></div><div class="line number20 index19 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">size.width&nbsp;=&nbsp;[representation&nbsp;pixelsWide];</code></div><div class="line number21 index20 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">size.height&nbsp;=&nbsp;[representation&nbsp;pixelsHigh];</code></div><div class="line number22 index21 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">}</code></div><div class="line number23 index22 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">NSRect&nbsp;rect&nbsp;=&nbsp;NSMakeRect(0.0,&nbsp;0.0,&nbsp;size.width,&nbsp;size.height);</code></div><div class="line number24 index23 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">CGImageRef&nbsp;imageRef&nbsp;=&nbsp;[image&nbsp;CGImageForProposedRect:&amp;rect&nbsp;context:NULL&nbsp;hints:nil];</code></div><div class="line number25 index24 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//calculate&nbsp;rows&nbsp;and&nbsp;columns</code></div><div class="line number26 index25 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">NSInteger&nbsp;rows&nbsp;=&nbsp;ceil(size.height&nbsp;/&nbsp;tileSize);</code></div><div class="line number27 index26 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">NSInteger&nbsp;cols&nbsp;=&nbsp;ceil(size.width&nbsp;/&nbsp;tileSize);</code></div><div class="line number28 index27 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//generate&nbsp;tiles</code></div><div class="line number29 index28 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js keyword">for</code>&nbsp;<code class="js plain">(int&nbsp;y&nbsp;=&nbsp;0;&nbsp;y&nbsp;&lt;&nbsp;rows;&nbsp;++y)&nbsp;{</code></div><div class="line number30 index29 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js keyword">for</code>&nbsp;<code class="js plain">(int&nbsp;x&nbsp;=&nbsp;0;&nbsp;x&nbsp;&lt;&nbsp;cols;&nbsp;++x)&nbsp;{</code></div><div class="line number31 index30 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//extract&nbsp;tile&nbsp;image</code></div><div class="line number32 index31 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">CGRect&nbsp;tileRect&nbsp;=&nbsp;CGRectMake(x*tileSize,&nbsp;y*tileSize,&nbsp;tileSize,&nbsp;tileSize);</code></div><div class="line number33 index32 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">CGImageRef&nbsp;tileImage&nbsp;=&nbsp;CGImageCreateWithImageInRect(imageRef,&nbsp;tileRect);</code></div><div class="line number34 index33 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//convert&nbsp;to&nbsp;jpeg&nbsp;data</code></div><div class="line number35 index34 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">NSBitmapImageRep&nbsp;*imageRep&nbsp;=&nbsp;[[NSBitmapImageRep&nbsp;alloc]&nbsp;initWithCGImage:tileImage];</code></div><div class="line number36 index35 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">NSData&nbsp;*data&nbsp;=&nbsp;[imageRep&nbsp;representationUsingType:&nbsp;NSJPEGFileType&nbsp;properties:nil];</code></div><div class="line number37 index36 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">CGImageRelease(tileImage);</code></div><div class="line number38 index37 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//save&nbsp;file</code></div><div class="line number39 index38 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">NSString&nbsp;*path&nbsp;=&nbsp;[outputPath&nbsp;stringByAppendingFormat:&nbsp;@</code><code class="js string">"_i_i.jpg"</code><code class="js plain">,&nbsp;x,&nbsp;y];</code></div><div class="line number40 index39 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">[data&nbsp;writeToFile:path&nbsp;atomically:NO];</code></div><div class="line number41 index40 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">}</code></div><div class="line number42 index41 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">}</code></div><div class="line number43 index42 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">}</code></div><div class="line number44 index43 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js keyword">return</code>&nbsp;<code class="js plain">0;</code></div><div class="line number45 index44 alt2"><code class="js plain">}</code></div></div></td></tr></tbody></table></div></div><p>这个程序将2048*2048分辨率的雪人图案裁剪成了64个不同的256*256的小图。（256*256是CATiledLayer的默认小图大小，默认大小可以通过tileSize属性更改）。程序接受一个图片路径作为命令行的第一个参数。我们可以在编译的scheme将路径参数硬编码然后就可以在Xcode中运行了，但是以后作用在另一个图片上就不方便了。所以，我们编译了这个程序并把它保存到敏感的地方，然后从终端调用，如下面所示：</p><div><div id="highlighter_642439" class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js plain">&gt;&nbsp;path/to/TileCutterApp&nbsp;path/to/Snowman.jpg</code></div></div></td></tr></tbody></table></div></div><p>The app is very basic, but could easily be extended to support additional arguments such as tile size, or to export images in formats other than JPEG. The result of running it is a sequence of 64 new images, named as follows:</p><p>这个程序相当基础，但是能够轻易地扩展支持额外的参数比如小图大小，或者导出格式等等。运行结果是64个新图的序列，如下面命名：</p><div><div id="highlighter_190966" class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js plain">Snowman_00_00.jpg</code></div><div class="line number2 index1 alt1"><code class="js plain">Snowman_00_01.jpg</code></div><div class="line number3 index2 alt2"><code class="js plain">Snowman_00_02.jpg</code></div><div class="line number4 index3 alt1"><code class="js plain">...</code></div><div class="line number5 index4 alt2"><code class="js plain">Snowman_07_07.jpg</code></div></div></td></tr></tbody></table></div></div><p>既然我们有了裁切后的小图，我们就要让iOS程序用到他们。CATiledLayer很好地和UIScrollView集成在一起。除了设置图层和滑动视图边界以适配整个图片大小，我们真正要做的就是实现-drawLayer:inContext:方法，当需要载入新的小图时，CATiledLayer就会调用到这个方法。</p><p>清单6.12演示了代码。图6.12是代码运行结果。</p><p>清单6.12 一个简单的滚动CATiledLayer实现</p><div><div id="highlighter_659640" class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js preprocessor">#import&nbsp;"ViewController.h"</code></div><div class="line number2 index1 alt1"><code class="js preprocessor">#import&nbsp;@interface&nbsp;ViewController&nbsp;()</code></div><div class="line number3 index2 alt2"><code class="js plain">@property&nbsp;(nonatomic,&nbsp;weak)&nbsp;IBOutlet&nbsp;UIScrollView&nbsp;*scrollView;</code></div><div class="line number4 index3 alt1"><code class="js plain">@end</code></div><div class="line number5 index4 alt2"><code class="js plain">@implementation&nbsp;ViewController</code></div><div class="line number6 index5 alt1"><code class="js plain">-&nbsp;(void)viewDidLoad</code></div><div class="line number7 index6 alt2"><code class="js plain">{</code></div><div class="line number8 index7 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">[</code><code class="js keyword">super</code>&nbsp;<code class="js plain">viewDidLoad];</code></div><div class="line number9 index8 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//add&nbsp;the&nbsp;tiled&nbsp;layer</code></div><div class="line number10 index9 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">CATiledLayer&nbsp;*tileLayer&nbsp;=&nbsp;[CATiledLayer&nbsp;layer];?</code></div><div class="line number11 index10 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">tileLayer.frame&nbsp;=&nbsp;CGRectMake(0,&nbsp;0,&nbsp;2048,&nbsp;2048);</code></div><div class="line number12 index11 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">tileLayer.delegate&nbsp;=&nbsp;self;&nbsp;[self.scrollView.layer&nbsp;addSublayer:tileLayer];</code></div><div class="line number13 index12 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//configure&nbsp;the&nbsp;scroll&nbsp;view</code></div><div class="line number14 index13 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">self.scrollView.contentSize&nbsp;=&nbsp;tileLayer.frame.size;</code></div><div class="line number15 index14 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//draw&nbsp;layer</code></div><div class="line number16 index15 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">[tileLayer&nbsp;setNeedsDisplay];</code></div><div class="line number17 index16 alt2"><code class="js plain">}</code></div><div class="line number18 index17 alt1"><code class="js plain">-&nbsp;(void)drawLayer:(CATiledLayer&nbsp;*)layer&nbsp;inContext:(CGContextRef)ctx</code></div><div class="line number19 index18 alt2"><code class="js plain">{</code></div><div class="line number20 index19 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//determine&nbsp;tile&nbsp;coordinate</code></div><div class="line number21 index20 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">CGRect&nbsp;bounds&nbsp;=&nbsp;CGContextGetClipBoundingBox(ctx);</code></div><div class="line number22 index21 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">NSInteger&nbsp;x&nbsp;=&nbsp;floor(bounds.origin.x&nbsp;/&nbsp;layer.tileSize.width);</code></div><div class="line number23 index22 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">NSInteger&nbsp;y&nbsp;=&nbsp;floor(bounds.origin.y&nbsp;/&nbsp;layer.tileSize.height);</code></div><div class="line number24 index23 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//load&nbsp;tile&nbsp;image</code></div><div class="line number25 index24 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">NSString&nbsp;*imageName&nbsp;=&nbsp;[NSString&nbsp;stringWithFormat:&nbsp;@"Snowman_i_i,&nbsp;x,&nbsp;y];</code></div><div class="line number26 index25 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">NSString&nbsp;*imagePath&nbsp;=&nbsp;[[NSBundle&nbsp;mainBundle]&nbsp;pathForResource:imageName&nbsp;ofType:@</code><code class="js string">"jpg"</code><code class="js plain">];</code></div><div class="line number27 index26 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">UIImage&nbsp;*tileImage&nbsp;=&nbsp;[UIImage&nbsp;imageWithContentsOfFile:imagePath];</code></div><div class="line number28 index27 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//draw&nbsp;tile</code></div><div class="line number29 index28 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">UIGraphicsPushContext(ctx);</code></div><div class="line number30 index29 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">[tileImage&nbsp;drawInRect:bounds];</code></div><div class="line number31 index30 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">UIGraphicsPopContext();</code></div><div class="line number32 index31 alt1"><code class="js plain">}</code></div><div class="line number33 index32 alt2"><code class="js plain">@end</code></div></div></td></tr></tbody></table></div></div><p style="text-align:center"><img src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/1420357461935435.png" title="1420357461935435.png" alt="6.12.png" style="width: 485px; height: 259px;"></p><p>图6.12 用UIScrollView滚动CATiledLayer</p><p>当你滑动这个图片，你会发现当CATiledLayer载入小图的时候，他们会淡入到界面中。这是CATiledLayer的默认行为。（你可能已经在iOS 6之前的苹果地图程序中见过这个效果）你可以用fadeDuration属性改变淡入时长或直接禁用掉。CATiledLayer（不同于大部分的UIKit和Core Animation方法）支持多线程绘制，-drawLayer:inContext:方法可以在多个线程中同时地并发调用，所以请小心谨慎地确保你在这个方法中实现的绘制代码是线程安全的。</p><p><span style="color: rgb(149, 55, 52);">Retina小图</span></p><p>你也许已经注意到了这些小图并不是以Retina的分辨率显示的。为了以屏幕的原生分辨率来渲染CATiledLayer，我们需要设置图层的contentsScale来匹配UIScreen的scale属性：</p><div><div id="highlighter_608392" class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js plain">tileLayer.contentsScale&nbsp;=&nbsp;[UIScreen&nbsp;mainScreen].scale;</code></div></div></td></tr></tbody></table></div></div><p>有趣的是，tileSize是以像素为单位，而不是点，所以增大了contentsScale就自动有了默认的小图尺寸（现在它是128*128的点而不是256*256）.所以，我们不需要手工更新小图的尺寸或是在Retina分辨率下指定一个不同的小图。我们需要做的是适应小图渲染代码以对应安排scale的变化，然而：</p><div><div id="highlighter_169749" class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js comments">//determine&nbsp;tile&nbsp;coordinate</code></div><div class="line number2 index1 alt1"><code class="js plain">CGRect&nbsp;bounds&nbsp;=&nbsp;CGContextGetClipBoundingBox(ctx);</code></div><div class="line number3 index2 alt2"><code class="js plain">CGFloat&nbsp;scale&nbsp;=&nbsp;[UIScreen&nbsp;mainScreen].scale;</code></div><div class="line number4 index3 alt1"><code class="js plain">NSInteger&nbsp;x&nbsp;=&nbsp;floor(bounds.origin.x&nbsp;/&nbsp;layer.tileSize.width&nbsp;*&nbsp;scale);</code></div><div class="line number5 index4 alt2"><code class="js plain">NSInteger&nbsp;y&nbsp;=&nbsp;floor(bounds.origin.y&nbsp;/&nbsp;layer.tileSize.height&nbsp;*&nbsp;scale);</code></div></div></td></tr></tbody></table></div></div><p>通过这个方法纠正scale也意味着我们的雪人图将以一半的大小渲染在Retina设备上（总尺寸是1024*1024，而不是2048*2048）。这个通常都不会影响到用CATiledLayer正常显示的图片类型（比如照片和地图，他们在设计上就是要支持放大缩小，能够在不同的缩放条件下显示），但是也需要在心里明白。</p><p><strong><span style="color: rgb(0, 0, 0);">CAEmitterLayer</span></strong></p><p>在iOS 5中，苹果引入了一个新的CALayer子类叫做CAEmitterLayer。CAEmitterLayer是一个高性能的粒子引擎，被用来创建实时例子动画如：烟雾，火，雨等等这些效果。</p><p>CAEmitterLayer看上去像是许多CAEmitterCell的容器，这些CAEmitierCell定义了一个例子效果。你将会为不同的例子效果定义一个或多个CAEmitterCell作为模版，同时CAEmitterLayer负责基于这些模版实例化一个粒子流。一个CAEmitterCell类似于一个CALayer：它有一个contents属性可以定义为一个CGImage，另外还有一些可设置属性控制着表现和行为。我们不会对这些属性逐一进行详细的描述，你们可以在CAEmitterCell类的头文件中找到。</p><p>我们来举个例子。我们将利用在一圆中发射不同速度和透明度的粒子创建一个火爆炸的效果。清单6.13包含了生成爆炸的代码。图6.13是运行结果</p><p>清单6.13 用CAEmitterLayer创建爆炸效果</p><div><div id="highlighter_806179" class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js preprocessor">#import&nbsp;"ViewController.h"</code></div><div class="line number2 index1 alt1"><code class="js preprocessor">#import&nbsp;@interface&nbsp;ViewController&nbsp;()</code></div><div class="line number3 index2 alt2"><code class="js plain">@property&nbsp;(nonatomic,&nbsp;weak)&nbsp;IBOutlet&nbsp;UIView&nbsp;*containerView;</code></div><div class="line number4 index3 alt1"><code class="js plain">@end</code></div><div class="line number5 index4 alt2"><code class="js plain">@implementation&nbsp;ViewController</code></div><div class="line number6 index5 alt1"><code class="js plain">-&nbsp;(void)viewDidLoad</code></div><div class="line number7 index6 alt2"><code class="js plain">{</code></div><div class="line number8 index7 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">[</code><code class="js keyword">super</code>&nbsp;<code class="js plain">viewDidLoad];</code></div><div class="line number9 index8 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">?</code></div><div class="line number10 index9 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//create&nbsp;particle&nbsp;emitter&nbsp;layer</code></div><div class="line number11 index10 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">CAEmitterLayer&nbsp;*emitter&nbsp;=&nbsp;[CAEmitterLayer&nbsp;layer];</code></div><div class="line number12 index11 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">emitter.frame&nbsp;=&nbsp;self.containerView.bounds;</code></div><div class="line number13 index12 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">[self.containerView.layer&nbsp;addSublayer:emitter];</code></div><div class="line number14 index13 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//configure&nbsp;emitter</code></div><div class="line number15 index14 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">emitter.renderMode&nbsp;=&nbsp;kCAEmitterLayerAdditive;</code></div><div class="line number16 index15 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">emitter.emitterPosition&nbsp;=&nbsp;CGPointMake(emitter.frame.size.width&nbsp;/&nbsp;2.0,&nbsp;emitter.frame.size.height&nbsp;/&nbsp;2.0);</code></div><div class="line number17 index16 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//create&nbsp;a&nbsp;particle&nbsp;template</code></div><div class="line number18 index17 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">CAEmitterCell&nbsp;*cell&nbsp;=&nbsp;[[CAEmitterCell&nbsp;alloc]&nbsp;init];</code></div><div class="line number19 index18 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">cell.contents&nbsp;=&nbsp;(__bridge&nbsp;id)[UIImage&nbsp;imageNamed:@</code><code class="js string">"Spark.png"</code><code class="js plain">].CGImage;</code></div><div class="line number20 index19 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">cell.birthRate&nbsp;=&nbsp;150;</code></div><div class="line number21 index20 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">cell.lifetime&nbsp;=&nbsp;5.0;</code></div><div class="line number22 index21 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">cell.color&nbsp;=&nbsp;[UIColor&nbsp;colorWithRed:1&nbsp;green:0.5&nbsp;blue:0.1&nbsp;alpha:1.0].CGColor;</code></div><div class="line number23 index22 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">cell.alphaSpeed&nbsp;=&nbsp;-0.4;</code></div><div class="line number24 index23 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">cell.velocity&nbsp;=&nbsp;50;</code></div><div class="line number25 index24 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">cell.velocityRange&nbsp;=&nbsp;50;</code></div><div class="line number26 index25 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">cell.emissionRange&nbsp;=&nbsp;M_PI&nbsp;*&nbsp;2.0;</code></div><div class="line number27 index26 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//add&nbsp;particle&nbsp;template&nbsp;to&nbsp;emitter</code></div><div class="line number28 index27 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">emitter.emitterCells&nbsp;=&nbsp;@[cell];</code></div><div class="line number29 index28 alt2"><code class="js plain">}</code></div><div class="line number30 index29 alt1"><code class="js plain">@end</code></div></div></td></tr></tbody></table></div></div><p>图6.13 火焰爆炸效果</p><p>CAEMitterCell的属性基本上可以分为三种：</p><ul class=" list-paddingleft-2" style="list-style-type: disc;"><li><p>这种粒子的某一属性的初始值。比如，color属性指定了一个可以混合图片内容颜色的混合色。在示例中，我们将它设置为桔色。</p></li><li><p>例子某一属性的变化范围。比如emissionRange属性的值是2π，这意味着例子可以从360度任意位置反射出来。如果指定一个小一些的值，就可以创造出一个圆锥形</p></li><li><p>指定值在时间线上的变化。比如，在示例中，我们将alphaSpeed设置为-0.4，就是说例子的透明度每过一秒就是减少0.4，这样就有发射出去之后逐渐小时的效果。</p></li></ul><p>CAEmitterLayer的属性它自己控制着整个例子系统的位置和形状。一些属性比如birthRate，lifetime和celocity，这些属性在CAEmitterCell中也有。这些属性会以相乘的方式作用在一起，这样你就可以用一个值来加速或者扩大整个例子系统。其他值得提到的属性有以下这些：</p><ul class=" list-paddingleft-2" style="list-style-type: disc;"><li><p>preservesDepth，是否将3D例子系统平面化到一个图层（默认值）或者可以在3D空间中混合其他的图层</p></li><li><p>renderMode，控制着在视觉上粒子图片是如何混合的。你可能已经注意到了示例中我们把它设置为kCAEmitterLayerAdditive，它实现了这样一个效果：合并例子重叠部分的亮度使得看上去更亮。如果我们把它设置为默认的kCAEmitterLayerUnordered，效果就没那么好看了（见图6.14）.</p></li></ul><p style="text-align:center"><img src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/1420357544349267.png" title="1420357544349267.png" alt="6.14.png" style="width: 483px; height: 247px;"></p><p>图6.14 禁止混色之后的火焰粒子</p><p><span style="color: rgb(0, 0, 0);"><strong>CAEAGLLayer</strong></span></p><p>当iOS要处理高性能图形绘制，必要时就是OpenGL。应该说它应该是最后的杀手锏，至少对于非游戏的应用来说是的。因为相比Core Animation和UIkit框架，它不可思议地复杂。</p><p>OpenGL提供了Core Animation的基础，它是底层的C接口，直接和iPhone，iPad的硬件通信，极少地抽象出来的方法。OpenGL没有对象或是图层的继承概念。它只是简单地处理三角形。OpenGL中所有东西都是3D空间中有颜色和纹理的三角形。用起来非常复杂和强大，但是用OpenGL绘制iOS用户界面就需要很多很多的工作了。</p><p>为了能够以高性能使用Core Animation，你需要判断你需要绘制哪种内容（矢量图形，例子，文本，等等），但后选择合适的图层去呈现这些内容，Core Animation中只有一些类型的内容是被高度优化的；所以如果你想绘制的东西并不能找到标准的图层类，想要得到高性能就比较费事情了。</p><p>因为OpenGL根本不会对你的内容进行假设，它能够绘制得相当快。利用OpenGL，你可以绘制任何你知道必要的集合信息和形状逻辑的内容。所以很多游戏都喜欢用OpenGL（这些情况下，Core Animation的限制就明显了：它优化过的内容类型并不一定能满足需求），但是这样依赖，方便的高度抽象接口就没了。</p><p>在iOS 5中，苹果引入了一个新的框架叫做GLKit，它去掉了一些设置OpenGL的复杂性，提供了一个叫做CLKView的UIView的子类，帮你处理大部分的设置和绘制工作。前提是各种各样的OpenGL绘图缓冲的底层可配置项仍然需要你用CAEAGLLayer完成，它是CALayer的一个子类，用来显示任意的OpenGL图形。</p><p>大部分情况下你都不需要手动设置CAEAGLLayer（假设用GLKView），过去的日子就不要再提了。特别的，我们将设置一个OpenGL ES 2.0的上下文，它是现代的iOS设备的标准做法。</p><p>尽管不需要GLKit也可以做到这一切，但是GLKit囊括了很多额外的工作，比如设置顶点和片段着色器，这些都以类C语言叫做GLSL自包含在程序中，同时在运行时载入到图形硬件中。编写GLSL代码和设置EAGLayer没有什么关系，所以我们将用GLKBaseEffect类将着色逻辑抽象出来。其他的事情，我们还是会有以往的方式。</p><p>在开始之前，你需要将GLKit和OpenGLES框架加入到你的项目中，然后就可以实现清单6.14中的代码，里面是设置一个GAEAGLLayer的最少工作，它使用了OpenGL ES 2.0 的绘图上下文，并渲染了一个有色三角（见图6.15）.</p><p>清单6.14 用CAEAGLLayer绘制一个三角形</p><div><div id="highlighter_147923" class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div><div class="line number37 index36 alt2">37</div><div class="line number38 index37 alt1">38</div><div class="line number39 index38 alt2">39</div><div class="line number40 index39 alt1">40</div><div class="line number41 index40 alt2">41</div><div class="line number42 index41 alt1">42</div><div class="line number43 index42 alt2">43</div><div class="line number44 index43 alt1">44</div><div class="line number45 index44 alt2">45</div><div class="line number46 index45 alt1">46</div><div class="line number47 index46 alt2">47</div><div class="line number48 index47 alt1">48</div><div class="line number49 index48 alt2">49</div><div class="line number50 index49 alt1">50</div><div class="line number51 index50 alt2">51</div><div class="line number52 index51 alt1">52</div><div class="line number53 index52 alt2">53</div><div class="line number54 index53 alt1">54</div><div class="line number55 index54 alt2">55</div><div class="line number56 index55 alt1">56</div><div class="line number57 index56 alt2">57</div><div class="line number58 index57 alt1">58</div><div class="line number59 index58 alt2">59</div><div class="line number60 index59 alt1">60</div><div class="line number61 index60 alt2">61</div><div class="line number62 index61 alt1">62</div><div class="line number63 index62 alt2">63</div><div class="line number64 index63 alt1">64</div><div class="line number65 index64 alt2">65</div><div class="line number66 index65 alt1">66</div><div class="line number67 index66 alt2">67</div><div class="line number68 index67 alt1">68</div><div class="line number69 index68 alt2">69</div><div class="line number70 index69 alt1">70</div><div class="line number71 index70 alt2">71</div><div class="line number72 index71 alt1">72</div><div class="line number73 index72 alt2">73</div><div class="line number74 index73 alt1">74</div><div class="line number75 index74 alt2">75</div><div class="line number76 index75 alt1">76</div><div class="line number77 index76 alt2">77</div><div class="line number78 index77 alt1">78</div><div class="line number79 index78 alt2">79</div><div class="line number80 index79 alt1">80</div><div class="line number81 index80 alt2">81</div><div class="line number82 index81 alt1">82</div><div class="line number83 index82 alt2">83</div><div class="line number84 index83 alt1">84</div><div class="line number85 index84 alt2">85</div><div class="line number86 index85 alt1">86</div><div class="line number87 index86 alt2">87</div><div class="line number88 index87 alt1">88</div><div class="line number89 index88 alt2">89</div><div class="line number90 index89 alt1">90</div><div class="line number91 index90 alt2">91</div><div class="line number92 index91 alt1">92</div><div class="line number93 index92 alt2">93</div><div class="line number94 index93 alt1">94</div><div class="line number95 index94 alt2">95</div><div class="line number96 index95 alt1">96</div><div class="line number97 index96 alt2">97</div><div class="line number98 index97 alt1">98</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js preprocessor">#import&nbsp;"ViewController.h"</code></div><div class="line number2 index1 alt1"><code class="js preprocessor">#import&nbsp;#import&nbsp;@interface&nbsp;ViewController&nbsp;()</code></div><div class="line number3 index2 alt2"><code class="js plain">@property&nbsp;(nonatomic,&nbsp;weak)&nbsp;IBOutlet&nbsp;UIView&nbsp;*glView;</code></div><div class="line number4 index3 alt1"><code class="js plain">@property&nbsp;(nonatomic,&nbsp;strong)&nbsp;EAGLContext&nbsp;*glContext;</code></div><div class="line number5 index4 alt2"><code class="js plain">@property&nbsp;(nonatomic,&nbsp;strong)&nbsp;CAEAGLLayer&nbsp;*glLayer;</code></div><div class="line number6 index5 alt1"><code class="js plain">@property&nbsp;(nonatomic,&nbsp;assign)&nbsp;GLuint&nbsp;framebuffer;</code></div><div class="line number7 index6 alt2"><code class="js plain">@property&nbsp;(nonatomic,&nbsp;assign)&nbsp;GLuint&nbsp;colorRenderbuffer;</code></div><div class="line number8 index7 alt1"><code class="js plain">@property&nbsp;(nonatomic,&nbsp;assign)&nbsp;GLint&nbsp;framebufferWidth;</code></div><div class="line number9 index8 alt2"><code class="js plain">@property&nbsp;(nonatomic,&nbsp;assign)&nbsp;GLint&nbsp;framebufferHeight;</code></div><div class="line number10 index9 alt1"><code class="js plain">@property&nbsp;(nonatomic,&nbsp;strong)&nbsp;GLKBaseEffect&nbsp;*effect;</code></div><div class="line number11 index10 alt2"><code class="js plain">?</code></div><div class="line number12 index11 alt1"><code class="js plain">@end</code></div><div class="line number13 index12 alt2"><code class="js plain">@implementation&nbsp;ViewController</code></div><div class="line number14 index13 alt1"><code class="js plain">-&nbsp;(void)setUpBuffers</code></div><div class="line number15 index14 alt2"><code class="js plain">{</code></div><div class="line number16 index15 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//set&nbsp;up&nbsp;frame&nbsp;buffer</code></div><div class="line number17 index16 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">glGenFramebuffers(1,&nbsp;&amp;_framebuffer);</code></div><div class="line number18 index17 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">glBindFramebuffer(GL_FRAMEBUFFER,&nbsp;_framebuffer);</code></div><div class="line number19 index18 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//set&nbsp;up&nbsp;color&nbsp;render&nbsp;buffer</code></div><div class="line number20 index19 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">glGenRenderbuffers(1,&nbsp;&amp;_colorRenderbuffer);</code></div><div class="line number21 index20 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">glBindRenderbuffer(GL_RENDERBUFFER,&nbsp;_colorRenderbuffer);</code></div><div class="line number22 index21 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">glFramebufferRenderbuffer(GL_FRAMEBUFFER,&nbsp;GL_COLOR_ATTACHMENT0,&nbsp;GL_RENDERBUFFER,&nbsp;_colorRenderbuffer);</code></div><div class="line number23 index22 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">[self.glContext&nbsp;renderbufferStorage:GL_RENDERBUFFER&nbsp;fromDrawable:self.glLayer];</code></div><div class="line number24 index23 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">glGetRenderbufferParameteriv(GL_RENDERBUFFER,&nbsp;GL_RENDERBUFFER_WIDTH,&nbsp;&amp;_framebufferWidth);</code></div><div class="line number25 index24 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">glGetRenderbufferParameteriv(GL_RENDERBUFFER,&nbsp;GL_RENDERBUFFER_HEIGHT,&nbsp;&amp;_framebufferHeight);</code></div><div class="line number26 index25 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//check&nbsp;success</code></div><div class="line number27 index26 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js keyword">if</code>&nbsp;<code class="js plain">(glCheckFramebufferStatus(GL_FRAMEBUFFER)&nbsp;!=&nbsp;GL_FRAMEBUFFER_COMPLETE)&nbsp;{</code></div><div class="line number28 index27 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">NSLog(@</code><code class="js string">"Failed&nbsp;to&nbsp;make&nbsp;complete&nbsp;framebuffer&nbsp;object:&nbsp;%i"</code><code class="js plain">,&nbsp;glCheckFramebufferStatus(GL_FRAMEBUFFER));</code></div><div class="line number29 index28 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">}</code></div><div class="line number30 index29 alt1"><code class="js plain">}</code></div><div class="line number31 index30 alt2"><code class="js plain">-&nbsp;(void)tearDownBuffers</code></div><div class="line number32 index31 alt1"><code class="js plain">{</code></div><div class="line number33 index32 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js keyword">if</code>&nbsp;<code class="js plain">(_framebuffer)&nbsp;{</code></div><div class="line number34 index33 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//delete&nbsp;framebuffer</code></div><div class="line number35 index34 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">glDeleteFramebuffers(1,&nbsp;&amp;_framebuffer);</code></div><div class="line number36 index35 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">_framebuffer&nbsp;=&nbsp;0;</code></div><div class="line number37 index36 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">}</code></div><div class="line number38 index37 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js keyword">if</code>&nbsp;<code class="js plain">(_colorRenderbuffer)&nbsp;{</code></div><div class="line number39 index38 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//delete&nbsp;color&nbsp;render&nbsp;buffer</code></div><div class="line number40 index39 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">glDeleteRenderbuffers(1,&nbsp;&amp;_colorRenderbuffer);</code></div><div class="line number41 index40 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">_colorRenderbuffer&nbsp;=&nbsp;0;</code></div><div class="line number42 index41 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">}</code></div><div class="line number43 index42 alt2"><code class="js plain">}</code></div><div class="line number44 index43 alt1"><code class="js plain">-&nbsp;(void)drawFrame&nbsp;{</code></div><div class="line number45 index44 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//bind&nbsp;framebuffer&nbsp;&amp;&nbsp;set&nbsp;viewport</code></div><div class="line number46 index45 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">glBindFramebuffer(GL_FRAMEBUFFER,&nbsp;_framebuffer);</code></div><div class="line number47 index46 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">glViewport(0,&nbsp;0,&nbsp;_framebufferWidth,&nbsp;_framebufferHeight);</code></div><div class="line number48 index47 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//bind&nbsp;shader&nbsp;program</code></div><div class="line number49 index48 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">[self.effect&nbsp;prepareToDraw];</code></div><div class="line number50 index49 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//clear&nbsp;the&nbsp;screen</code></div><div class="line number51 index50 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">glClear(GL_COLOR_BUFFER_BIT);&nbsp;glClearColor(0.0,&nbsp;0.0,&nbsp;0.0,&nbsp;1.0);</code></div><div class="line number52 index51 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//set&nbsp;up&nbsp;vertices</code></div><div class="line number53 index52 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">GLfloat&nbsp;vertices[]&nbsp;=&nbsp;{</code></div><div class="line number54 index53 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">-0.5f,&nbsp;-0.5f,&nbsp;-1.0f,&nbsp;0.0f,&nbsp;0.5f,&nbsp;-1.0f,&nbsp;0.5f,&nbsp;-0.5f,&nbsp;-1.0f,</code></div><div class="line number55 index54 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">};</code></div><div class="line number56 index55 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//set&nbsp;up&nbsp;colors</code></div><div class="line number57 index56 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">GLfloat&nbsp;colors[]&nbsp;=&nbsp;{</code></div><div class="line number58 index57 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">0.0f,&nbsp;0.0f,&nbsp;1.0f,&nbsp;1.0f,&nbsp;0.0f,&nbsp;1.0f,&nbsp;0.0f,&nbsp;1.0f,&nbsp;1.0f,&nbsp;0.0f,&nbsp;0.0f,&nbsp;1.0f,</code></div><div class="line number59 index58 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">};</code></div><div class="line number60 index59 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//draw&nbsp;triangle</code></div><div class="line number61 index60 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">glEnableVertexAttribArray(GLKVertexAttribPosition);</code></div><div class="line number62 index61 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">glEnableVertexAttribArray(GLKVertexAttribColor);</code></div><div class="line number63 index62 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">glVertexAttribPointer(GLKVertexAttribPosition,&nbsp;3,&nbsp;GL_FLOAT,&nbsp;GL_FALSE,&nbsp;0,&nbsp;vertices);</code></div><div class="line number64 index63 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">glVertexAttribPointer(GLKVertexAttribColor,4,&nbsp;GL_FLOAT,&nbsp;GL_FALSE,&nbsp;0,&nbsp;colors);</code></div><div class="line number65 index64 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">glDrawArrays(GL_TRIANGLES,&nbsp;0,&nbsp;3);</code></div><div class="line number66 index65 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//present&nbsp;render&nbsp;buffer</code></div><div class="line number67 index66 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">glBindRenderbuffer(GL_RENDERBUFFER,&nbsp;_colorRenderbuffer);</code></div><div class="line number68 index67 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">[self.glContext&nbsp;presentRenderbuffer:GL_RENDERBUFFER];</code></div><div class="line number69 index68 alt2"><code class="js plain">}</code></div><div class="line number70 index69 alt1"><code class="js plain">-&nbsp;(void)viewDidLoad</code></div><div class="line number71 index70 alt2"><code class="js plain">{</code></div><div class="line number72 index71 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">[</code><code class="js keyword">super</code>&nbsp;<code class="js plain">viewDidLoad];</code></div><div class="line number73 index72 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//set&nbsp;up&nbsp;context</code></div><div class="line number74 index73 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">self.glContext&nbsp;=&nbsp;[[EAGLContext&nbsp;alloc]&nbsp;initWithAPI:&nbsp;kEAGLRenderingAPIOpenGLES2];</code></div><div class="line number75 index74 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">[EAGLContext&nbsp;setCurrentContext:self.glContext];</code></div><div class="line number76 index75 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//set&nbsp;up&nbsp;layer</code></div><div class="line number77 index76 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">self.glLayer&nbsp;=&nbsp;[CAEAGLLayer&nbsp;layer];</code></div><div class="line number78 index77 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">self.glLayer.frame&nbsp;=&nbsp;self.glView.bounds;</code></div><div class="line number79 index78 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">[self.glView.layer&nbsp;addSublayer:self.glLayer];</code></div><div class="line number80 index79 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">self.glLayer.drawableProperties&nbsp;=&nbsp;@{kEAGLDrawablePropertyRetainedBacking:@NO,&nbsp;kEAGLDrawablePropertyColorFormat:&nbsp;kEAGLColorFormatRGBA8};</code></div><div class="line number81 index80 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//set&nbsp;up&nbsp;base&nbsp;effect</code></div><div class="line number82 index81 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">self.effect&nbsp;=&nbsp;[[GLKBaseEffect&nbsp;alloc]&nbsp;init];</code></div><div class="line number83 index82 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//set&nbsp;up&nbsp;buffers</code></div><div class="line number84 index83 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">[self&nbsp;setUpBuffers];</code></div><div class="line number85 index84 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//draw&nbsp;frame</code></div><div class="line number86 index85 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">[self&nbsp;drawFrame];</code></div><div class="line number87 index86 alt2"><code class="js plain">}</code></div><div class="line number88 index87 alt1"><code class="js plain">-&nbsp;(void)viewDidUnload</code></div><div class="line number89 index88 alt2"><code class="js plain">{</code></div><div class="line number90 index89 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">[self&nbsp;tearDownBuffers];</code></div><div class="line number91 index90 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">[</code><code class="js keyword">super</code>&nbsp;<code class="js plain">viewDidUnload];</code></div><div class="line number92 index91 alt1"><code class="js plain">}</code></div><div class="line number93 index92 alt2"><code class="js plain">-&nbsp;(void)dealloc</code></div><div class="line number94 index93 alt1"><code class="js plain">{</code></div><div class="line number95 index94 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">[self&nbsp;tearDownBuffers];</code></div><div class="line number96 index95 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">[EAGLContext&nbsp;setCurrentContext:nil];</code></div><div class="line number97 index96 alt2"><code class="js plain">}</code></div><div class="line number98 index97 alt1"><code class="js plain">@end</code></div></div></td></tr></tbody></table></div></div><p style="text-align:center"><img src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/1420357602876221.png" title="1420357602876221.png" alt="6.15.png" style="width: 486px; height: 244px;"></p><p>图6.15 用OpenGL渲染的CAEAGLLayer图层</p><p>在一个真正的OpenGL应用中，我们可能会用NSTimer或CADisplayLink周期性地每秒钟调用-drawRrame方法60次，同时会将几何图形生成和绘制分开以便不会每次都重新生成三角形的顶点（这样也可以让我们绘制其他的一些东西而不是一个三角形而已），不过上面这个例子已经足够演示了绘图原则了。</p><p><strong><span style="color: rgb(0, 0, 0);">AVPlayerLayer</span></strong></p><p>最后一个图层类型是AVPlayerLayer。尽管它不是Core Animation框架的一部分（AV前缀看上去像），AVPlayerLayer是有别的框架（AVFoundation）提供的，它和Core Animation紧密地结合在一起，提供了一个CALayer子类来显示自定义的内容类型。</p><p>AVPlayerLayer是用来在iOS上播放视频的。他是高级接口例如MPMoivePlayer的底层实现，提供了显示视频的底层控制。AVPlayerLayer的使用相当简单：你可以用+playerLayerWithPlayer:方法创建一个已经绑定了视频播放器的图层，或者你可以先创建一个图层，然后用player属性绑定一个AVPlayer实例。</p><p>在我们开始之前，我们需要添加AVFoundation到我们的项目中。然后，清单6.15创建了一个简单的电影播放器，图6.16是代码运行结果。</p><p>清单6.15 用AVPlayerLayer播放视频</p><div><div id="highlighter_143208" class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js preprocessor">#import&nbsp;"ViewController.h"</code></div><div class="line number2 index1 alt1"><code class="js preprocessor">#import&nbsp;#import&nbsp;@interface&nbsp;ViewController&nbsp;()</code></div><div class="line number3 index2 alt2"><code class="js plain">@property&nbsp;(nonatomic,&nbsp;weak)&nbsp;IBOutlet&nbsp;UIView&nbsp;*containerView;&nbsp;@end</code></div><div class="line number4 index3 alt1"><code class="js plain">@implementation&nbsp;ViewController</code></div><div class="line number5 index4 alt2"><code class="js plain">-&nbsp;(void)viewDidLoad</code></div><div class="line number6 index5 alt1"><code class="js plain">{</code></div><div class="line number7 index6 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">[</code><code class="js keyword">super</code>&nbsp;<code class="js plain">viewDidLoad];</code></div><div class="line number8 index7 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//get&nbsp;video&nbsp;URL</code></div><div class="line number9 index8 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">NSURL&nbsp;*URL&nbsp;=&nbsp;[[NSBundle&nbsp;mainBundle]&nbsp;URLForResource:@</code><code class="js string">"Ship"</code>&nbsp;<code class="js plain">withExtension:@</code><code class="js string">"mp4"</code><code class="js plain">];</code></div><div class="line number10 index9 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//create&nbsp;player&nbsp;and&nbsp;player&nbsp;layer</code></div><div class="line number11 index10 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">AVPlayer&nbsp;*player&nbsp;=&nbsp;[AVPlayer&nbsp;playerWithURL:URL];</code></div><div class="line number12 index11 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">AVPlayerLayer&nbsp;*playerLayer&nbsp;=&nbsp;[AVPlayerLayer&nbsp;playerLayerWithPlayer:player];</code></div><div class="line number13 index12 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//set&nbsp;player&nbsp;layer&nbsp;frame&nbsp;and&nbsp;attach&nbsp;it&nbsp;to&nbsp;our&nbsp;view</code></div><div class="line number14 index13 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">playerLayer.frame&nbsp;=&nbsp;self.containerView.bounds;</code></div><div class="line number15 index14 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">[self.containerView.layer&nbsp;addSublayer:playerLayer];</code></div><div class="line number16 index15 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//play&nbsp;the&nbsp;video</code></div><div class="line number17 index16 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">[player&nbsp;play];</code></div><div class="line number18 index17 alt1"><code class="js plain">}</code></div><div class="line number19 index18 alt2"><code class="js plain">@end</code></div></div></td></tr></tbody></table></div></div><p style="text-align:center"><img src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/1420357667602647.png" title="1420357667602647.png" alt="6.16.png"></p><p>图6.16 用AVPlayerLayer图层播放视频的截图<br></p><p>我们用代码创建了一个AVPlayerLayer，但是我们仍然把它添加到了一个容器视图中，而不是直接在controller中的主视图上添加。这样其实是为了可以使用自动布局限制使得图层在最中间；否则，一旦设备被旋转了我们就要手动重新放置位置，因为Core Animation并不支持自动大小和自动布局（见第三章『图层几何学』）。</p><p>当然，因为AVPlayerLayer是CALayer的子类，它继承了父类的所有特性。我们并不会受限于要在一个矩形中播放视频；清单6.16演示了在3D，圆角，有色边框，蒙板，阴影等效果（见图6.17）.</p><p>清单6.16 给视频增加变换，边框和圆角</p><div><div id="highlighter_803106" class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js plain">-&nbsp;(void)viewDidLoad</code></div><div class="line number2 index1 alt1"><code class="js plain">{</code></div><div class="line number3 index2 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">...</code></div><div class="line number4 index3 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//set&nbsp;player&nbsp;layer&nbsp;frame&nbsp;and&nbsp;attach&nbsp;it&nbsp;to&nbsp;our&nbsp;view</code></div><div class="line number5 index4 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">playerLayer.frame&nbsp;=&nbsp;self.containerView.bounds;</code></div><div class="line number6 index5 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">[self.containerView.layer&nbsp;addSublayer:playerLayer];</code></div><div class="line number7 index6 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//transform&nbsp;layer</code></div><div class="line number8 index7 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">CATransform3D&nbsp;transform&nbsp;=&nbsp;CATransform3DIdentity;</code></div><div class="line number9 index8 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">transform.m34&nbsp;=&nbsp;-1.0&nbsp;/&nbsp;500.0;</code></div><div class="line number10 index9 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">transform&nbsp;=&nbsp;CATransform3DRotate(transform,&nbsp;M_PI_4,&nbsp;1,&nbsp;1,&nbsp;0);</code></div><div class="line number11 index10 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">playerLayer.transform&nbsp;=&nbsp;transform;</code></div><div class="line number12 index11 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">?</code></div><div class="line number13 index12 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//add&nbsp;rounded&nbsp;corners&nbsp;and&nbsp;border</code></div><div class="line number14 index13 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">playerLayer.masksToBounds&nbsp;=&nbsp;YES;</code></div><div class="line number15 index14 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">playerLayer.cornerRadius&nbsp;=&nbsp;20.0;</code></div><div class="line number16 index15 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">playerLayer.borderColor&nbsp;=&nbsp;[UIColor&nbsp;redColor].CGColor;</code></div><div class="line number17 index16 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">playerLayer.borderWidth&nbsp;=&nbsp;5.0;</code></div><div class="line number18 index17 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">//play&nbsp;the&nbsp;video</code></div><div class="line number19 index18 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">[player&nbsp;play];</code></div><div class="line number20 index19 alt1"><code class="js plain">}</code></div></div></td></tr></tbody></table></div></div><p style="text-align:center"><img src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/1420357696693467.png" title="1420357696693467.png" alt="6.17.png"></p><p>图6.17 3D视角下的边框和圆角AVPlayerLayer<br></p><p><strong>总结</strong></p><p>这一章我们简要概述了一些专用图层以及用他们实现的一些效果，我们只是了解到这些图层的皮毛，像CATiledLayer和CAEMitterLayer这些类可以单独写一章的。但是，重点是记住CALayer是用处很大的，而且它并没有为所有可能的场景进行优化。为了获得Core Animation最好的性能，你需要为你的工作选对正确的工具，希望你能够挖掘这些不同的CALayer子类的功能。 这一章我们通过CAEmitterLayer和AVPlayerLayer类简单地接触到了一些动画，在第二章，我们将继续深入研究动画，就从隐式动画开始。<br></p>
			</div>
			<div id="page" style="padding:0"></div>
                
			<div class="wx_article">	
				<div class="article_weixin">				
					<img src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/article_weixin.jpg" width="131" height="131" alt="搜索CocoaChina微信公众号：CocoaChina">
					<div class="article_scan">微信扫一扫</div>
					<div class="article_txt"><span style="color:#999999">订阅每日移动开发及APP推广热点资讯<br>公众号：</span>CocoaChina</div>
				</div>
			</div>
			
		   <div class="clearfix tgbox">
				<a href="http://www.cocoachina.com/deliver.php" class="tg float-l" target="_blank">我要投稿</a>&nbsp;&nbsp;
				<a style="margin-left:10px" href="javascript:void(0)" onclick="add_favors(10827,&#39;iOS-Core-Animation-Advanced-Techniques(三)&#39;)" class="tg float-l">收藏文章</a>
				<div class="share float-r">分享到：
					<div class="bdsharebuttonbox" id="sharediv" data-bd-bind="1425369749489"><a href="http://www.cocoachina.com/ios/20150105/10827.html#" class="bds_more" data-cmd="more"></a> <a href="http://www.cocoachina.com/ios/20150105/10827.html#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a><a href="http://www.cocoachina.com/ios/20150105/10827.html#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a> <a href="http://www.cocoachina.com/ios/20150105/10827.html#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a></div>
				</div>
			</div>			
			
			
			<a class="zanbox" href="javascript:void(0)" id="zanbox" onclick="postDigg(&#39;good&#39;,10827)" title="哎呦，不错噢，赞一个">
				<strong id="newdigg">
				 <script src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/count(2).php" language="javascript"></script>7
				</strong>
			</a>			
		</div>
    
        	<div class="article-prev">上一篇：<a href="http://www.cocoachina.com/ios/20150104/10826.html">NSObject的load和initialize方法</a> </div>
            <div class="article-next">下一篇：<a href="http://www.cocoachina.com/ios/20150105/10829.html">iOS-Core-Animation-Advanced-Techniques(五)</a> </div>
      	
		<!--相关资讯-->
		<div class="part-wrap clearfix">
			<h3>相关资讯</h3>
			<ul class="info-list clearfix">
            	<li>
                	<a href="http://www.cocoachina.com/ios/20150106/10840.html" target="_blank" title="术语绘图通常在Core Animation的上下文中指代软件绘图（意即：不由GPU协助的绘图）。在iOS中，软件绘图通常是由Core Graphics框架完成来完成。但是，在一些必要的情况下，相比Core Animation和OpenGL，Core Gr">iOS-Core-Animation-Advanced-Techniques(七)</a>          
             	</li>
<li>
                	<a href="http://www.cocoachina.com/ios/20150106/10839.html" target="_blank" title="在第10章“缓冲”中，我们研究了CAMediaTimingFunction，它是一个通过控制动画缓冲来模拟物理效果例如加速或者减速来增强现实感的东西，那么如果想更加真实地模拟物理交互或者实时根据用户输入修改">iOS-Core-Animation-Advanced-Techniques(六)</a>          
             	</li>
<li>
                	<a href="http://www.cocoachina.com/ios/20150105/10829.html" target="_blank" title="动画的发生是需要持续一段时间的，所以计时对整个概念来说至关重要。在这一章中，我们来看看CAMediaTiming，看看Core Animation是如何跟踪时间的">iOS-Core-Animation-Advanced-Techniques(五)</a>          
             	</li>
<li>
                	<a href="http://www.cocoachina.com/ios/20150104/10816.html" target="_blank" title="圆角矩形是iOS的一个标志性审美特性。这在iOS的每一个地方都得到了体现，不论是主屏幕图标，还是警告弹框，甚至是文本框。按照这流行程度，你可能会认为一定有不借助Photoshop就能轻易创建圆角举">iOS-Core-Animation-Advanced-Techniques（二）</a>          
             	</li>
<li>
                	<a href="http://www.cocoachina.com/ios/20150104/10814.html" target="_blank" title="Core Animation其实是一个令人误解的命名。你可能认为它只是用来做动画的，但实际上它是从一个叫做Layer Kit这么一个不怎么和动画有关的名字演变而来，所以做动画这只是Core Animation特性的冰山一角">iOS-Core-Animation-Advanced-Techniques（一）</a>          
             	</li>
<li>
                	<a href="http://www.cocoachina.com/ios/20150105/10812.html" target="_blank" title="Core Animation基于一个假设，说屏幕上的任何东西都可以（或者可能）做动画。动画并不需要你在Core Animation中手动打开，相反需要明确地关闭，否则他会一直存在。当你改变CALayer的一个可做动画的属性">iOS-Core-Animation-Advanced-Techniques（四）</a>          
             	</li>
<li>
                	<a href="http://www.cocoachina.com/ios/20141022/10005.html" target="_blank" title="在iOS中随处都可以看到绚丽的动画效果，实现这些动画的过程并不复杂，今天将带大家一窥iOS动画全貌。在这里你可以看到iOS中如何使用图层精简非交互式绘图，如何通过核心动画创建基础动画"> iOS开发之让你的应用“动”起来</a>          
             	</li>
<li>
                	<a href="http://www.cocoachina.com/ios/20141009/9850.html" target="_blank" title="KTV歌词视图，只要去过KTV的朋友一定不会陌生。我们先来看一下最终的效果，再一步步说明唱吧歌词视图的演进。想把事件事情说得清清楚楚的确很难，有很多tricky的地方；另外毕竟不是o">基于Core Animation的KTV歌词视图的平滑实现</a>          
             	</li>
<li>
                	<a href="http://www.cocoachina.com/ios/20140701/8995.html" target="_blank" title="说到Core Animation不能不说Layer，一个个Layer通过tree的结构组织起来，在Display的过程中实际上有3种Layer tree。1、model layer tree；2、presentation tree；3、render tree">Core Animation基本概念和Additive Animation</a>          
             	</li>
<li>
                	<a href="http://www.cocoachina.com/ios/20131230/7627.html" target="_blank" title="本文由海水的味道翻译 本文是《Core Animation Programming Guide》2013-01-28更新版本的译文。本本文是《Core Animation Programming Guide》2013-01-28更新版本的译文。本文略去了原文中关于OS X平台上Core Animati">Core Animation编程指南</a>          
             	</li>
			
			</ul>
		</div>  
		<iframe id="comiframe" src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/get_comments.html" width="750" frameborder="0" scrolling="no" height="510"></iframe>
		<script type="text/javascript">
			var reinit;

			function reinitIframe(){
				var iframe = document.getElementById("comiframe");
				var src = $("#comiframe").attr('src');
				try{
				var indexof = src.indexOf("cn.cocos2d-x.org/comment/get_comments");
				if(src!='' && indexof<0 ){
					var bHeight = iframe.contentWindow.document.body.scrollHeight;
					
					var dHeight = iframe.contentWindow.document.documentElement.scrollHeight;
				
					var height = Math.max(bHeight, dHeight);
					iframe.height =  parseInt(height)+180;
					if(height!='150'){
					var src_new=src.replace("www.cocoachina.com/comment.php","cn.cocos2d-x.org/comment/get_comments");
					$("#comiframe").attr("src",src_new);

					clearInterval(reinit);
					}
				}
				}catch(ex){
				}
			}
			reinit = window.setInterval("reinitIframe()", 1200);
		</script>	
		
		
	</div>
    <!--./left-->
            <!--侧边栏-->
            <div class="clearfix newslist">
                <div class="rightSide detail-right float-r">                                       
                    <!--两周热门资讯推荐-->
                    <div> 
                        <div class="part-wrap clearfix">
                            <h3>热门资讯</h3>
                            <ul class="related-hot">
								<li class="clearfix"><a href="http://www.cocoachina.com/ios/20150225/11190.html" class="float-l pic" target="_blank" title="Xcode 的正确打开方式——Debugging"><img src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/771387e456429431512a0bcb9fe784da.png" style="max-height:60px" alt="Xcode 的正确打开方式——Debugging"></a><div style="margin-left:86px"><p class="related-intro"><a href="http://www.cocoachina.com/ios/20150225/11190.html" target="_blank" title="Xcode 的正确打开方式——Debugging">Xcode 的正确打开方式——Debugging</a></p><p class="hits">点击量<span>7984</span></p></div></li><li class="clearfix"><a href="http://www.cocoachina.com/special/20150228/11210.html" class="float-l pic" target="_blank" title="iOS开发进阶，从Xcode开始"><img src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/a5d77d869199671428f0c0c57fd72b0d.jpg" style="max-height:60px" alt="iOS开发进阶，从Xcode开始"></a><div style="margin-left:86px"><p class="related-intro"><a href="http://www.cocoachina.com/special/20150228/11210.html" target="_blank" title="iOS开发进阶，从Xcode开始">iOS开发进阶，从Xcode开始</a></p><p class="hits">点击量<span>6273</span></p></div></li><li class="clearfix"><a href="http://www.cocoachina.com/ios/20150225/11163.html" class="float-l pic" target="_blank" title="iOS性能优化：Instruments使用实战"><img src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/92ec095a85d19ede7c963f70a6a07639.jpg" style="max-height:60px" alt="iOS性能优化：Instruments使用实战"></a><div style="margin-left:86px"><p class="related-intro"><a href="http://www.cocoachina.com/ios/20150225/11163.html" target="_blank" title="iOS性能优化：Instruments使用实战">iOS性能优化：Instruments使用实战</a></p><p class="hits">点击量<span>4705</span></p></div></li><li class="clearfix"><a href="http://www.cocoachina.com/ios/20150227/11203.html" class="float-l pic" target="_blank" title="Facebook发布Origami Live for iOS，并更新Origami"><img src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/e52f58cb5a328690ec4610838e90f6a1.jpg" style="max-height:60px" alt="Facebook发布Origami Live for iOS，并更新Origami"></a><div style="margin-left:86px"><p class="related-intro"><a href="http://www.cocoachina.com/ios/20150227/11203.html" target="_blank" title="Facebook发布Origami Live for iOS，并更新Origami">Facebook发布Origami Live for iOS，并更新Origami</a></p><p class="hits">点击量<span>4702</span></p></div></li><li class="clearfix"><a href="http://www.cocoachina.com/programmer/20150225/11181.html" class="float-l pic" target="_blank" title="创业者的新春礼包—优秀免费资源300+"><img src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/fdb917287226892a5dc43bdde6cc0004.jpg" style="max-height:60px" alt="创业者的新春礼包—优秀免费资源300+"></a><div style="margin-left:86px"><p class="related-intro"><a href="http://www.cocoachina.com/programmer/20150225/11181.html" target="_blank" title="创业者的新春礼包—优秀免费资源300+">创业者的新春礼包—优秀免费资源300+</a></p><p class="hits">点击量<span>4426</span></p></div></li><li class="clearfix"><a href="http://www.cocoachina.com/programmer/20150227/11199.html" class="float-l pic" target="_blank" title="30岁：程序员心中永远的痛？"><img src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/8fc3233a7cccbb809068cdf1e9551d1c.jpg" style="max-height:60px" alt="30岁：程序员心中永远的痛？"></a><div style="margin-left:86px"><p class="related-intro"><a href="http://www.cocoachina.com/programmer/20150227/11199.html" target="_blank" title="30岁：程序员心中永远的痛？">30岁：程序员心中永远的痛？</a></p><p class="hits">点击量<span>3709</span></p></div></li><li class="clearfix"><a href="http://www.cocoachina.com/apple/20150227/11200.html" class="float-l pic" target="_blank" title="苹果3月9日发布会邀请函曝光"><img src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/5cb019790b652a5721b0835ebba9743b.jpg" style="max-height:60px" alt="苹果3月9日发布会邀请函曝光"></a><div style="margin-left:86px"><p class="related-intro"><a href="http://www.cocoachina.com/apple/20150227/11200.html" target="_blank" title="苹果3月9日发布会邀请函曝光">苹果3月9日发布会邀请函曝光</a></p><p class="hits">点击量<span>3643</span></p></div></li><li class="clearfix"><a href="http://www.cocoachina.com/ios/20150225/11189.html" class="float-l pic" target="_blank" title="Xcode插件AllTargets开发教程"><img src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/66c33764f14e3cd1c4e3380f6f07f049.jpg" style="max-height:60px" alt="Xcode插件AllTargets开发教程"></a><div style="margin-left:86px"><p class="related-intro"><a href="http://www.cocoachina.com/ios/20150225/11189.html" target="_blank" title="Xcode插件AllTargets开发教程">Xcode插件AllTargets开发教程</a></p><p class="hits">点击量<span>3366</span></p></div></li><li class="clearfix"><a href="http://www.cocoachina.com/programmer/20150302/11215.html" class="float-l pic" target="_blank" title="10句话立马激怒程序猿，杀伤力爆棚～"><img src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/889cfffb3c1f694534cc7587b3fc3b5c.GIF" style="max-height:60px" alt="10句话立马激怒程序猿，杀伤力爆棚～"></a><div style="margin-left:86px"><p class="related-intro"><a href="http://www.cocoachina.com/programmer/20150302/11215.html" target="_blank" title="10句话立马激怒程序猿，杀伤力爆棚～">10句话立马激怒程序猿，杀伤力爆棚～</a></p><p class="hits">点击量<span>3325</span></p></div></li><li class="clearfix noborder-b"><a href="http://www.cocoachina.com/webapp/20150227/11204.html" class="float-l pic" target="_blank" title="腾讯移动Web整体解决方案--Spirit"><img src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/add1.jpg" style="max-height:60px" alt="腾讯移动Web整体解决方案--Spirit"></a><div style="margin-left:86px"><p class="related-intro"><a href="http://www.cocoachina.com/webapp/20150227/11204.html" target="_blank" title="腾讯移动Web整体解决方案--Spirit">腾讯移动Web整体解决方案--Spirit</a></p><p class="hits">点击量<span>2245</span></p></div></li>	                             
                            </ul>
                        </div>
                   </div>
                   <!--./两周热门资讯推荐-->
                    <!-- 广告位：资讯频道列表页面右侧300*90-->
                    <div class="job-ad"><script>CNZZ_SLOT_RENDER('324555');</script><script type="text/javascript" charset="gbk" src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/appgcm(1).php"></script></div>
                   <!--综合评论--> 
                    <div class="part-wrap clearfix" style="margin-top: 15px;">
                        <h3>综合评论</h3>
                        <ul class="related-comment clearfix">
							<li><span class="hide_comment">楼主，想拜师</span><br><p><span>fiveyears</span><span>评论了</span><a href="http://www.cocoachina.com/ios/20150303/11218.html" title="iOS开发路线简述" target="_blank"><span>iOS开发路线简述</span></a></p></li><li><span class="hide_comment">沙发</span><br><p><span>阿花君霸占路人</span><span>评论了</span><a href="http://www.cocoachina.com/design/20150303/11219.html" title="Facebook产品设计总监！设计APP时的14个..." target="_blank"><span>Facebook产品设计总监！设计APP时的14个...</span></a></p></li><li><span class="hide_comment">骗人的</span><br><p><span>763883169</span><span>评论了</span><a href="http://www.cocoachina.com/ios/20101210/2456.html" title="自定义UIActionSheet弹出框的代码例子" target="_blank"><span>自定义UIActionSheet弹出框的代码例子</span></a></p></li><li><span class="hide_comment">简直就是坑爹的活动。周围的人都在摇，摇半天都摇不到一个，谁还看你的彩蛋情怀</span><br><p><span>chenquanjun</span><span>评论了</span><a href="http://www.cocoachina.com/design/20150302/11214.html" title="微信春晚摇一摇项目经验总结（产品篇）" target="_blank"><span>微信春晚摇一摇项目经验总结（产品篇）</span></a></p></li><li><span class="hide_comment">是的，软件工程师就是要既懂技术，又懂管理，既能文又能武，而且要具备强壮的体魄应付加班，最重要的是要不看重报酬（工人们比你们辛苦多了）</span><br><p><span>cheunjq</span><span>评论了</span><a href="http://www.cocoachina.com/programmer/20150228/11167.html" title="为什么软件工程师应该养成写作的习惯？" target="_blank"><span>为什么软件工程师应该养成写作的习惯？</span></a></p></li><li><span class="hide_comment">感谢分享</span><br><p><span>lingyj</span><span>评论了</span><a href="http://www.cocoachina.com/ios/20150228/11206.html" title="使用Cocoapods创建私有podspec" target="_blank"><span>使用Cocoapods创建私有podspec</span></a></p></li><li><span class="hide_comment">you can you up ,no can no BB</span><br><p><span>月子30</span><span>评论了</span><a href="http://www.cocoachina.com/programmer/20150302/11215.html" title="10句话立马激怒程序猿，杀伤力爆棚～" target="_blank"><span>10句话立马激怒程序猿，杀伤力爆棚～</span></a></p></li><li><span class="hide_comment">没有搜索结果啊</span><br><p><span>surfaceeee</span><span>评论了</span><a href="http://www.cocoachina.com/ios/20140114/7696.html" title=" iOS系类教程之用instruments来检验你..." target="_blank"><span> iOS系类教程之用instruments来检验你...</span></a></p></li><li><span class="hide_comment">恶心不,这个项目早就不更新了,点开github看看代码更新时间,首页居然还是2013年的行业报告,

用这个还不如bootstrap3</span><br><p><span>minguo</span><span>评论了</span><a href="http://www.cocoachina.com/webapp/20150227/11204.html" title="腾讯移动Web整体解决方案--Spirit" target="_blank"><span>腾讯移动Web整体解决方案--Spirit</span></a></p></li><li class="noborder-b"><span class="hide_comment">回复 <a target="_blank" href="http://www.cocoachina.com/bbs/u.php?uid=311021">fenglin123： </a>我也是这么想的。</span><br><p><span>king2142</span><span>评论了</span><a href="http://www.cocoachina.com/programmer/20150227/11199.html" title="30岁：程序员心中永远的痛？" target="_blank"><span>30岁：程序员心中永远的痛？</span></a></p></li>						   
                        </ul>
                    </div>
                    <!--./综合评论-->
                    <!--相关帖子--> 
                    <div class="part-wrap clearfix" style="margin:15px 0 15px 0;">
                        <h3>相关帖子</h3>
                        <ul class="related-comment clearfix">
							<script charset="gb2312" src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/new.php"></script><li><a href="http://www.cocoachina.com/bbs/read.php?tid=286719" target="_blank">cocos2dx3.0 如何使用lua_tocfunction？</a></li><li><a href="http://www.cocoachina.com/bbs/read.php?tid=286718" target="_blank">iOS开发键盘设置</a></li><li><a href="http://www.cocoachina.com/bbs/read.php?tid=286717" target="_blank">quick 3.3使用的是哪一个framework！</a></li><li><a href="http://www.cocoachina.com/bbs/read.php?tid=286715" target="_blank">Medium的可扩展滚动页面--MediumScrollFullScreen</a></li><li><a href="http://www.cocoachina.com/bbs/read.php?tid=286714" target="_blank">第三方库 iCarousel 有在它上放过tableView的吗？</a></li><li><a href="http://www.cocoachina.com/bbs/read.php?tid=286713" target="_blank">cocos2dx，两个string+string崩溃了，求解啊</a></li><li><a href="http://www.cocoachina.com/bbs/read.php?tid=286712" target="_blank">【预告】加特技的约会——恋爱手游《约吗》元宵节上线，唯美原画预放</a></li><li><a href="http://www.cocoachina.com/bbs/read.php?tid=286710" target="_blank">quick中怎么对spine增加事件监听？</a></li><li class="clearfix noborder-b"><a href="http://www.cocoachina.com/bbs/read.php?tid=286709" target="_blank">3D效果转场效果警示图--MJAlertView</a></li>						
                        </ul>
                    </div>
                    <!--./相关帖子-->  
					<iframe width="230" height="550" class="share_self" frameborder="0" scrolling="no" src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/index.html"></iframe>
                </div>
            </div> 
            <!--./侧边栏-->           
		</div>
<div id="coco-store" style="display:none">
	<div class="storebox">
    	<h5>提示</h5>
        <h3>已经收藏该篇文章</h3>
        <p class="p1"><a href="http://www.cocoachina.com/bbs/u.php?action=favor&tag=1" target="_blank">去我的收藏夹</a></p>
        <p class="p2"><a href="http://www.cocoachina.com/bbs/login.php">请登录</a></p>
    </div>
</div> <!--收藏提示-->       

<script type="text/javascript">

function postDigg(ftype,aid)
{
	var taget_obj = document.getElementById('newdigg'); 
	var saveid = GetCookie('diggid');
	if(saveid != null)
	{
		var saveids = saveid.split(',');
		var hasid = false;
		saveid = '';
		j = 1;
		for(i=saveids.length-1;i>=0;i--)
		{
			if(saveids[i]==aid && hasid) continue;
			else {
				if(saveids[i]==aid && !hasid) hasid = true;
				saveid += (saveid=='' ? saveids[i] : ','+saveids[i]);
				j++;
				if(j==20 && hasid) break;
				if(j==19 && !hasid) break;
			}
		}
		if(hasid) { alert("您已经顶过该帖，请不要重复顶帖 ！"); return; }
		else saveid += ','+aid;
		SetCookie('diggid',saveid,1);
	}
	else
	{
		SetCookie('diggid',aid,1);
	}
	myajax = new DedeAjax(taget_obj,false,false,'','','');
	var url = "/cms/plus/digg_ajax.php?action="+ftype+"&id="+aid;
	myajax.SendGet2(url);
	DedeXHTTP = null;
	$('#zanbox').addClass('zanbox-selected');	
}
function getDigg(aid)
{
	var taget_obj = document.getElementById('newdigg');
	myajax = new DedeAjax(taget_obj,false,false,'','','');
	myajax.SendGet2("/cms/plus/digg_ajax.php?id="+aid);
	DedeXHTTP = null;
}


//显示对应的导航：
$(function(){
	var article_id = $('#article_id').val();
	var saveid = GetCookie('diggid');

	if(saveid != null)
	{
		var saveids = saveid.split(',');
		var hasid = false;
		saveid = '';
		j = 1;
		for(i=saveids.length-1;i>=0;i--)
		{
			if(saveids[i]==article_id && hasid) continue;
			else {
				if(saveids[i]==article_id && !hasid) hasid = true;
				saveid += (saveid=='' ? saveids[i] : ','+saveids[i]);
				j++;
				if(j==20 && hasid) break;
				if(j==19 && !hasid) break;
			}
		}
		
		if(hasid) 
		{ 
			$('#zanbox').addClass('zanbox-selected');			
		}

	}	


	// 根据作者名更新链接
	
	function updateAuthor(name) {
		if(name != "pockry" && name!= "suiling" && name!= "wupeng") {
			name = "suiling";
		}
		var urls = {
			"pockry": "http://www.cocoachina.com/bbs/u.php?action=feed&username=pockry",
			"suiling": "http://www.cocoachina.com/bbs/u.php?action=feed&uid=340873",
			"wupeng": "http://www.cocoachina.com/bbs/u.php?action=feed&uid=304691"
		};
		$("#field_author").attr("href", urls[name]).html(name);
	}
	updateAuthor("suiling");

});

window.onload = function() {
	
	$('#sharediv').removeClass('bdshare-button-style1-32');
	$('#sharediv').attr('class','bdsharebuttonbox');
}; 
</script>
<script type="text/javascript" src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/shCore.js"></script>
	<script type="text/javascript" src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/brush.js"></script>
	<link type="text/css" rel="stylesheet" href="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/shCoreDefault.css">
	<script type="text/javascript">
	//SyntaxHighlighter.config.clipboardSwf = '/js/scripts/clipboard.swf';

	SyntaxHighlighter.all();</script>


<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"iOS-Core-Animation-Advanced-Techniques(三) - 来自CocoaChina苹果开发中文站@CocoaChina","bdMini":"2","bdMiniList":false,"bdPic":"http://api.cocoachina.com/uploads/150104/ce3c6fd7e7068c4a6bf9325baacc8b9b.jpg","bdStyle":"1","bdSize":"32"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api//js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>
<!--./cont-->

</div>    
<!--右侧浮动-->
    <div class="r-bar" style="position: fixed; top: inherit; bottom: 10px;">
        <img src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/coco_weixin.png" class="weixin">
    	<a href="http://weibo.com/cocoachina" target="_blank" title="" class="weibo">sina</a>
        <a href="javascript:void(0);" target="_blank" title="" class="feedback">weixin</a>
        <a href="mailto:support@cocoachina.com" title="" class="kefu">mail</a>
        <a href="javascript:;" title="回到顶部" class="returntop" style="display: inline;">回到顶部</a>
    </div>

<script type="text/javascript">
$(function(){
	function search_check()
	{
		var search_keyword = $('#search_keyword').val();

		if( search_keyword.length < 2 )
		{
			alert("搜索关键字不能少于2个字节，请重新输入。");
		}
		else
		{
			$('#searchform').submit();
		}
	}


	var type = $('#type_name').html();
	if(type)
	{	
		switch( type )
		{
			case 'iOS开发':
				$('#ios').addClass('light');
				break;
			case 'AppStore研究':
				$('#app_store').addClass('light');
				break;
			case 'Mac开发':
				$('#mac').addClass('light');
				break;
			case '产品设计':
				$('#design').addClass('light');
				break;
			case 'Cocos引擎':
				$('#cocos').addClass('light');
				break;
			case 'WebApp':
				$('#webapp').addClass('light');
				break;
			case 'Swift':
				$('#swift').addClass('light');
				break;
			case '游戏开发':
				$('#game').addClass('light');
				break;
			case '苹果相关':
				$('#apple').addClass('light');
				break;
			case '营销推广':
				$('#market').addClass('light');
				break;		
			case '业界动态':
				$('#industry').addClass('light');
				break;	
			case '程序人生':
				$('#programmer').addClass('light');
				break;																																
				
		}
	}
});
</script>
<!--./cont-->
<script type="text/javascript" src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/index.js"></script>
<script src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/jquery.colorbox-min.js" type="text/javascript"></script>
<script language="javascript" src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/bbsauth_new2015.php" type="text/javascript"></script>
<script src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/script.js" type="text/javascript"></script>
<script type="text/javascript">
			jQuery(function()
			{
				//更改文章来源
				var source = $('#source a').html();								
				if( source == '未知' )
					jQuery('#source a').html('CocoaChina');
				if( jQuery('#source a').attr('href')=='')
					jQuery('#source').html('来源：'+source);
				
				//获取用户登录的id
				var content = jQuery('.t-lid').attr("href");
				var uid = 0;
				if( content )
				{
					content = content.split('=');
					uid = content[1];
				}
				var timestamp = new Date().getTime();	
				var uid2 = parseInt(uid);
				if(uid2==uid && uid2!=0){
					uid = uid<<2;			
					uid = uid+''+timestamp;
				}else{
					uid = "";
				}
				var oIframe=document.getElementById("comiframe");
				if(oIframe){
					var oUrl=window.location.href;
					oUrl = encodeURIComponent(oUrl);

					oIframe.src="http://www.cocoachina.com/comment.php?url="+oUrl+"&uid="+uid;
				}
				
			});
		</script>
<!--footer-->
<div class="footer clearfix">
    <div class="footer-b">
    	<div><a href="http://www.cocoachina.com/aboutus/index.html" target="_blank">关于我们</a><a href="http://www.cocoachina.com/contactus/index.html" target="_blank">广告合作</a><a target="_blank" href="mailto:support@cocoachina.com">联系我们</a></div>
    	<p>©CocoaChina 2010-2014 
        <i> <a href="http://www.miibeian.gov.cn/" target="_blank">京ICP备 11006519号 　京ICP证 100954号</a> 京公网安备11010502020289 
			<a href="http://182.131.21.137/ccnt-apply/admin/business/preview/business-preview!lookUrlRFID.action?main_id=A580B24B1AE846CE9DA949026D63939F" target="_blank">
				<img src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/jingwen.png" style="margin: -10px auto -14px -10px;">
			京网文[2012]0426-138号</a>		
		</i>
		</p>
    </div>    
</div>
<!--./footer-->
<script language="javascript" type="text/javascript" src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/dedeajax2-min.js"></script>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-16940817-2']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
  
 
function search_check()
{
	var search_keyword = $('#search_keyword').val();

	if( search_keyword.length < 2 )
	{
		alert("搜索关键字不能少于2个字节，请重新输入。");
	}
	else
	{
		$('#searchform').submit();
	}
}

</script>
<script>CNZZ_SLOT_RENDER('337970');</script><script type="text/javascript" charset="gbk" src="./iOS-Core-Animation-Advanced-Techniques(三) - CocoaChina 苹果开发中文站 - 最热的iPhone开发社区 最热的苹果开发社区 最热的iPad开发社区_files/appgcm(2).php"></script><div id="cnzz_slot_337970" style="width:-1px;height:-1px;border:none;margin:0px;padding:0px;background-color:#FFFFFF;overflow:hidden;"></div>


<div id="cboxOverlay" style="display: none;"></div><div id="colorbox" class="" style="display: none;"><div id="cboxWrapper"><div><div id="cboxTopLeft" style="float: left;"></div><div id="cboxTopCenter" style="float: left;"></div><div id="cboxTopRight" style="float: left;"></div></div><div style="clear: left;"><div id="cboxMiddleLeft" style="float: left;"></div><div id="cboxContent" style="float: left;"><div id="cboxLoadedContent" style="width: 0px; height: 0px; overflow: hidden; float: left;"></div><div id="cboxLoadingOverlay" style="float: left;"></div><div id="cboxLoadingGraphic" style="float: left;"></div><div id="cboxTitle" style="float: left;"></div><div id="cboxCurrent" style="float: left;"></div><div id="cboxNext" style="float: left;"></div><div id="cboxPrevious" style="float: left;"></div><div id="cboxSlideshow" style="float: left;"></div><div id="cboxClose" style="float: left;"></div></div><div id="cboxMiddleRight" style="float: left;"></div></div><div style="clear: left;"><div id="cboxBottomLeft" style="float: left;"></div><div id="cboxBottomCenter" style="float: left;"></div><div id="cboxBottomRight" style="float: left;"></div></div></div><div style="position: absolute; width: 9999px; visibility: hidden; display: none;"></div></div></body></html>